<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>üêî My Virtual Chicken üêî</title>

    <!-- PWA Support for persistent storage -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="My Chicken" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="theme-color" content="#ff69b4" />
    <link
      rel="apple-touch-icon"
      href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üêî</text></svg>"
    />
    <link
      rel="manifest"
      href="data:application/json,%7B%22name%22%3A%22My%20Virtual%20Chicken%22%2C%22short_name%22%3A%22Chicken%22%2C%22start_url%22%3A%22.%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%23fff0f5%22%2C%22theme_color%22%3A%22%23ff69b4%22%2C%22icons%22%3A%5B%7B%22src%22%3A%22data%3Aimage%2Fsvg%2Bxml%2C%253Csvg%2520xmlns%3D'http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg'%2520viewBox%3D'0%25200%2520100%2520100'%253E%253Ctext%2520y%3D'.9em'%2520font-size%3D'90'%253E%25F0%259F%2590%2594%253C%2Ftext%253E%253C%2Fsvg%253E%22%2C%22sizes%22%3A%22any%22%2C%22type%22%3A%22image%2Fsvg%2Bxml%22%7D%5D%7D"
    />

    <!-- QR Code Scanner library (jsQR) -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <!-- QR Code library (qrcode-generator 1.4.4, MIT License, embedded for offline use) -->
    <script>
      var qrcode = (function () {
        var qrcode = function (typeNumber, errorCorrectionLevel) {
          var PAD0 = 0xec,
            PAD1 = 0x11,
            _typeNumber = typeNumber,
            _errorCorrectionLevel =
              QRErrorCorrectionLevel[errorCorrectionLevel],
            _modules = null,
            _moduleCount = 0,
            _dataCache = null,
            _dataList = [],
            _this = {},
            makeImpl = function (test, maskPattern) {
              _moduleCount = _typeNumber * 4 + 17;
              _modules = (function (moduleCount) {
                var modules = new Array(moduleCount);
                for (var row = 0; row < moduleCount; row += 1) {
                  modules[row] = new Array(moduleCount);
                  for (var col = 0; col < moduleCount; col += 1) {
                    modules[row][col] = null;
                  }
                }
                return modules;
              })(_moduleCount);
              setupPositionProbePattern(0, 0);
              setupPositionProbePattern(_moduleCount - 7, 0);
              setupPositionProbePattern(0, _moduleCount - 7);
              setupPositionAdjustPattern();
              setupTimingPattern();
              setupTypeInfo(test, maskPattern);
              if (_typeNumber >= 7) {
                setupTypeNumber(test);
              }
              if (_dataCache == null) {
                _dataCache = createData(
                  _typeNumber,
                  _errorCorrectionLevel,
                  _dataList
                );
              }
              mapData(_dataCache, maskPattern);
            },
            setupPositionProbePattern = function (row, col) {
              for (var r = -1; r <= 7; r += 1) {
                if (row + r <= -1 || _moduleCount <= row + r) continue;
                for (var c = -1; c <= 7; c += 1) {
                  if (col + c <= -1 || _moduleCount <= col + c) continue;
                  if (
                    (0 <= r && r <= 6 && (c == 0 || c == 6)) ||
                    (0 <= c && c <= 6 && (r == 0 || r == 6)) ||
                    (2 <= r && r <= 4 && 2 <= c && c <= 4)
                  ) {
                    _modules[row + r][col + c] = true;
                  } else {
                    _modules[row + r][col + c] = false;
                  }
                }
              }
            },
            getBestMaskPattern = function () {
              var minLostPoint = 0,
                pattern = 0;
              for (var i = 0; i < 8; i += 1) {
                makeImpl(true, i);
                var lostPoint = QRUtil.getLostPoint(_this);
                if (i == 0 || minLostPoint > lostPoint) {
                  minLostPoint = lostPoint;
                  pattern = i;
                }
              }
              return pattern;
            },
            setupTimingPattern = function () {
              for (var r = 8; r < _moduleCount - 8; r += 1) {
                if (_modules[r][6] != null) continue;
                _modules[r][6] = r % 2 == 0;
              }
              for (var c = 8; c < _moduleCount - 8; c += 1) {
                if (_modules[6][c] != null) continue;
                _modules[6][c] = c % 2 == 0;
              }
            },
            setupPositionAdjustPattern = function () {
              var pos = QRUtil.getPatternPosition(_typeNumber);
              for (var i = 0; i < pos.length; i += 1) {
                for (var j = 0; j < pos.length; j += 1) {
                  var row = pos[i],
                    col = pos[j];
                  if (_modules[row][col] != null) continue;
                  for (var r = -2; r <= 2; r += 1) {
                    for (var c = -2; c <= 2; c += 1) {
                      if (
                        r == -2 ||
                        r == 2 ||
                        c == -2 ||
                        c == 2 ||
                        (r == 0 && c == 0)
                      ) {
                        _modules[row + r][col + c] = true;
                      } else {
                        _modules[row + r][col + c] = false;
                      }
                    }
                  }
                }
              }
            },
            setupTypeNumber = function (test) {
              var bits = QRUtil.getBCHTypeNumber(_typeNumber);
              for (var i = 0; i < 18; i += 1) {
                var mod = !test && ((bits >> i) & 1) == 1;
                _modules[Math.floor(i / 3)][(i % 3) + _moduleCount - 8 - 3] =
                  mod;
              }
              _modules[Math.floor(i / 3)][(i % 3) + _moduleCount - 8 - 3] = mod;
              for (var i = 0; i < 18; i += 1) {
                var mod = !test && ((bits >> i) & 1) == 1;
                _modules[(i % 3) + _moduleCount - 8 - 3][Math.floor(i / 3)] =
                  mod;
              }
            },
            setupTypeInfo = function (test, maskPattern) {
              var data = (_errorCorrectionLevel << 3) | maskPattern,
                bits = QRUtil.getBCHTypeInfo(data);
              for (var i = 0; i < 15; i += 1) {
                var mod = !test && ((bits >> i) & 1) == 1;
                if (i < 6) {
                  _modules[i][8] = mod;
                } else if (i < 8) {
                  _modules[i + 1][8] = mod;
                } else {
                  _modules[_moduleCount - 15 + i][8] = mod;
                }
              }
              for (var i = 0; i < 15; i += 1) {
                var mod = !test && ((bits >> i) & 1) == 1;
                if (i < 8) {
                  _modules[8][_moduleCount - i - 1] = mod;
                } else if (i < 9) {
                  _modules[8][15 - i - 1 + 1] = mod;
                } else {
                  _modules[8][15 - i - 1] = mod;
                }
              }
              _modules[_moduleCount - 8][8] = !test;
            },
            mapData = function (data, maskPattern) {
              var inc = -1,
                row = _moduleCount - 1,
                bitIndex = 7,
                byteIndex = 0,
                maskFunc = QRUtil.getMaskFunction(maskPattern);
              for (var col = _moduleCount - 1; col > 0; col -= 2) {
                if (col == 6) col -= 1;
                while (true) {
                  for (var c = 0; c < 2; c += 1) {
                    if (_modules[row][col - c] == null) {
                      var dark = false;
                      if (byteIndex < data.length) {
                        dark = ((data[byteIndex] >>> bitIndex) & 1) == 1;
                      }
                      if (maskFunc(row, col - c)) {
                        dark = !dark;
                      }
                      _modules[row][col - c] = dark;
                      bitIndex -= 1;
                      if (bitIndex == -1) {
                        byteIndex += 1;
                        bitIndex = 7;
                      }
                    }
                  }
                  row += inc;
                  if (row < 0 || _moduleCount <= row) {
                    row -= inc;
                    inc = -inc;
                    break;
                  }
                }
              }
            },
            createBytes = function (buffer, rsBlocks) {
              var offset = 0,
                maxDcCount = 0,
                maxEcCount = 0,
                dcdata = new Array(rsBlocks.length),
                ecdata = new Array(rsBlocks.length);
              for (var r = 0; r < rsBlocks.length; r += 1) {
                var dcCount = rsBlocks[r].dataCount,
                  ecCount = rsBlocks[r].totalCount - dcCount;
                maxDcCount = Math.max(maxDcCount, dcCount);
                maxEcCount = Math.max(maxEcCount, ecCount);
                dcdata[r] = new Array(dcCount);
                for (var i = 0; i < dcdata[r].length; i += 1) {
                  dcdata[r][i] = 0xff & buffer.getBuffer()[i + offset];
                }
                offset += dcCount;
                var rsPoly = QRUtil.getErrorCorrectPolynomial(ecCount),
                  rawPoly = qrPolynomial(dcdata[r], rsPoly.getLength() - 1),
                  modPoly = rawPoly.mod(rsPoly);
                ecdata[r] = new Array(rsPoly.getLength() - 1);
                for (var i = 0; i < ecdata[r].length; i += 1) {
                  var modIndex = i + modPoly.getLength() - ecdata[r].length;
                  ecdata[r][i] = modIndex >= 0 ? modPoly.getAt(modIndex) : 0;
                }
              }
              var totalCodeCount = 0;
              for (var i = 0; i < rsBlocks.length; i += 1) {
                totalCodeCount += rsBlocks[i].totalCount;
              }
              var data = new Array(totalCodeCount),
                index = 0;
              for (var i = 0; i < maxDcCount; i += 1) {
                for (var r = 0; r < rsBlocks.length; r += 1) {
                  if (i < dcdata[r].length) {
                    data[index] = dcdata[r][i];
                    index += 1;
                  }
                }
              }
              for (var i = 0; i < maxEcCount; i += 1) {
                for (var r = 0; r < rsBlocks.length; r += 1) {
                  if (i < ecdata[r].length) {
                    data[index] = ecdata[r][i];
                    index += 1;
                  }
                }
              }
              return data;
            },
            createData = function (typeNumber, errorCorrectionLevel, dataList) {
              var rsBlocks = QRRSBlock.getRSBlocks(
                  typeNumber,
                  errorCorrectionLevel
                ),
                buffer = qrBitBuffer();
              for (var i = 0; i < dataList.length; i += 1) {
                var data = dataList[i];
                buffer.put(data.getMode(), 4);
                buffer.put(
                  data.getLength(),
                  QRUtil.getLengthInBits(data.getMode(), typeNumber)
                );
                data.write(buffer);
              }
              var totalDataCount = 0;
              for (var i = 0; i < rsBlocks.length; i += 1) {
                totalDataCount += rsBlocks[i].dataCount;
              }
              if (buffer.getLengthInBits() > totalDataCount * 8) {
                throw new Error(
                  "code length overflow. (" +
                    buffer.getLengthInBits() +
                    ">" +
                    totalDataCount * 8 +
                    ")"
                );
              }
              if (buffer.getLengthInBits() + 4 <= totalDataCount * 8) {
                buffer.put(0, 4);
              }
              while (buffer.getLengthInBits() % 8 != 0) {
                buffer.putBit(false);
              }
              while (true) {
                if (buffer.getLengthInBits() >= totalDataCount * 8) break;
                buffer.put(PAD0, 8);
                if (buffer.getLengthInBits() >= totalDataCount * 8) break;
                buffer.put(PAD1, 8);
              }
              return createBytes(buffer, rsBlocks);
            };
          _this.addData = function (data) {
            var newData = qr8BitByte(data);
            _dataList.push(newData);
            _dataCache = null;
          };
          _this.isDark = function (row, col) {
            if (
              row < 0 ||
              _moduleCount <= row ||
              col < 0 ||
              _moduleCount <= col
            ) {
              throw new Error(row + "," + col);
            }
            return _modules[row][col];
          };
          _this.getModuleCount = function () {
            return _moduleCount;
          };
          _this.make = function () {
            makeImpl(false, getBestMaskPattern());
          };
          _this.createTableTag = function (cellSize, margin) {
            cellSize = cellSize || 2;
            margin = typeof margin == "undefined" ? cellSize * 4 : margin;
            var qrHtml = "";
            qrHtml += '<table style="';
            qrHtml += " border-width: 0px; border-style: none;";
            qrHtml += " border-collapse: collapse;";
            qrHtml += " padding: 0px; margin: " + margin + "px;";
            qrHtml += '">';
            qrHtml += "<tbody>";
            for (var r = 0; r < _this.getModuleCount(); r += 1) {
              qrHtml += "<tr>";
              for (var c = 0; c < _this.getModuleCount(); c += 1) {
                qrHtml += '<td style="';
                qrHtml += " border-width: 0px; border-style: none;";
                qrHtml += " border-collapse: collapse;";
                qrHtml += " padding: 0px; margin: 0px;";
                qrHtml += " width: " + cellSize + "px;";
                qrHtml += " height: " + cellSize + "px;";
                qrHtml += " background-color: ";
                qrHtml += _this.isDark(r, c) ? "#000000" : "#ffffff";
                qrHtml += ";";
                qrHtml += '"/>';
              }
              qrHtml += "</tr>";
            }
            qrHtml += "</tbody>";
            qrHtml += "</table>";
            return qrHtml;
          };
          _this.createImgTag = function (cellSize, margin) {
            cellSize = cellSize || 2;
            margin = typeof margin == "undefined" ? cellSize * 4 : margin;
            var size = _this.getModuleCount() * cellSize + margin * 2,
              min = margin,
              max = size - margin;
            return createImgTag(size, size, function (x, y) {
              if (min <= x && x < max && min <= y && y < max) {
                var c = Math.floor((x - min) / cellSize),
                  r = Math.floor((y - min) / cellSize);
                return _this.isDark(r, c) ? 0 : 1;
              } else {
                return 1;
              }
            });
          };
          return _this;
        };
        qrcode.stringToBytes = function (s) {
          var bytes = [];
          for (var i = 0; i < s.length; i += 1) {
            var c = s.charCodeAt(i);
            bytes.push(c & 0xff);
          }
          return bytes;
        };
        qrcode.createStringToBytes = function (unicodeData, numChars) {
          var unicodeMap = (function () {
            var bin = base64DecodeInputStream(unicodeData),
              buf = [];
            try {
              while (true) {
                var b = bin.read();
                if (b == -1) break;
                buf.push(b);
              }
            } catch (e) {}
            return buf;
          })();
          var unknownChar = "?".charCodeAt(0);
          return function (s) {
            var bytes = [];
            for (var i = 0; i < s.length; i += 1) {
              var c = s.charCodeAt(i);
              if (c < 128) {
                bytes.push(c);
              } else {
                var b = unknownChar;
                if (c < numChars) {
                  b = unicodeMap[c];
                }
                bytes.push(b);
              }
            }
            return bytes;
          };
        };
        var QRMode = {
            MODE_NUMBER: 1 << 0,
            MODE_ALPHA_NUM: 1 << 1,
            MODE_8BIT_BYTE: 1 << 2,
            MODE_KANJI: 1 << 3,
          },
          QRErrorCorrectionLevel = { L: 1, M: 0, Q: 3, H: 2 },
          QRMaskPattern = {
            PATTERN000: 0,
            PATTERN001: 1,
            PATTERN010: 2,
            PATTERN011: 3,
            PATTERN100: 4,
            PATTERN101: 5,
            PATTERN110: 6,
            PATTERN111: 7,
          },
          QRUtil = (function () {
            var PATTERN_POSITION_TABLE = [
                [],
                [6, 18],
                [6, 22],
                [6, 26],
                [6, 30],
                [6, 34],
                [6, 22, 38],
                [6, 24, 42],
                [6, 26, 46],
                [6, 28, 50],
                [6, 30, 54],
                [6, 32, 58],
                [6, 34, 62],
                [6, 26, 46, 66],
                [6, 26, 48, 70],
                [6, 26, 50, 74],
                [6, 30, 54, 78],
                [6, 30, 56, 82],
                [6, 30, 58, 86],
                [6, 34, 62, 90],
                [6, 28, 50, 72, 94],
                [6, 26, 50, 74, 98],
                [6, 30, 54, 78, 102],
                [6, 28, 54, 80, 106],
                [6, 32, 58, 84, 110],
                [6, 30, 58, 86, 114],
                [6, 34, 62, 90, 118],
                [6, 26, 50, 74, 98, 122],
                [6, 30, 54, 78, 102, 126],
                [6, 26, 52, 78, 104, 130],
                [6, 30, 56, 82, 108, 134],
                [6, 34, 60, 86, 112, 138],
                [6, 30, 58, 86, 114, 142],
                [6, 34, 62, 90, 118, 146],
                [6, 30, 54, 78, 102, 126, 150],
                [6, 24, 50, 76, 102, 128, 154],
                [6, 28, 54, 80, 106, 132, 158],
                [6, 32, 58, 84, 110, 136, 162],
                [6, 26, 54, 82, 110, 138, 166],
                [6, 30, 58, 86, 114, 142, 170],
              ],
              G15 =
                (1 << 10) |
                (1 << 8) |
                (1 << 5) |
                (1 << 4) |
                (1 << 2) |
                (1 << 1) |
                (1 << 0),
              G18 =
                (1 << 12) |
                (1 << 11) |
                (1 << 10) |
                (1 << 9) |
                (1 << 8) |
                (1 << 5) |
                (1 << 2) |
                (1 << 0),
              G15_MASK =
                (1 << 14) | (1 << 12) | (1 << 10) | (1 << 4) | (1 << 1),
              _this = {},
              getBCHDigit = function (data) {
                var digit = 0;
                while (data != 0) {
                  digit += 1;
                  data >>>= 1;
                }
                return digit;
              };
            _this.getBCHTypeInfo = function (data) {
              var d = data << 10;
              while (getBCHDigit(d) - getBCHDigit(G15) >= 0) {
                d ^= G15 << (getBCHDigit(d) - getBCHDigit(G15));
              }
              return ((data << 10) | d) ^ G15_MASK;
            };
            _this.getBCHTypeNumber = function (data) {
              var d = data << 12;
              while (getBCHDigit(d) - getBCHDigit(G18) >= 0) {
                d ^= G18 << (getBCHDigit(d) - getBCHDigit(G18));
              }
              return (data << 12) | d;
            };
            _this.getPatternPosition = function (typeNumber) {
              return PATTERN_POSITION_TABLE[typeNumber - 1];
            };
            _this.getMaskFunction = function (maskPattern) {
              switch (maskPattern) {
                case QRMaskPattern.PATTERN000:
                  return function (i, j) {
                    return (i + j) % 2 == 0;
                  };
                case QRMaskPattern.PATTERN001:
                  return function (i, j) {
                    return i % 2 == 0;
                  };
                case QRMaskPattern.PATTERN010:
                  return function (i, j) {
                    return j % 3 == 0;
                  };
                case QRMaskPattern.PATTERN011:
                  return function (i, j) {
                    return (i + j) % 3 == 0;
                  };
                case QRMaskPattern.PATTERN100:
                  return function (i, j) {
                    return (Math.floor(i / 2) + Math.floor(j / 3)) % 2 == 0;
                  };
                case QRMaskPattern.PATTERN101:
                  return function (i, j) {
                    return ((i * j) % 2) + ((i * j) % 3) == 0;
                  };
                case QRMaskPattern.PATTERN110:
                  return function (i, j) {
                    return (((i * j) % 2) + ((i * j) % 3)) % 2 == 0;
                  };
                case QRMaskPattern.PATTERN111:
                  return function (i, j) {
                    return (((i * j) % 3) + ((i + j) % 2)) % 2 == 0;
                  };
                default:
                  throw new Error("bad maskPattern:" + maskPattern);
              }
            };
            _this.getErrorCorrectPolynomial = function (errorCorrectLength) {
              var a = qrPolynomial([1], 0);
              for (var i = 0; i < errorCorrectLength; i += 1) {
                a = a.multiply(qrPolynomial([1, QRMath.gexp(i)], 0));
              }
              return a;
            };
            _this.getLengthInBits = function (mode, type) {
              if (1 <= type && type < 10) {
                switch (mode) {
                  case QRMode.MODE_NUMBER:
                    return 10;
                  case QRMode.MODE_ALPHA_NUM:
                    return 9;
                  case QRMode.MODE_8BIT_BYTE:
                    return 8;
                  case QRMode.MODE_KANJI:
                    return 8;
                  default:
                    throw new Error("mode:" + mode);
                }
              } else if (type < 27) {
                switch (mode) {
                  case QRMode.MODE_NUMBER:
                    return 12;
                  case QRMode.MODE_ALPHA_NUM:
                    return 11;
                  case QRMode.MODE_8BIT_BYTE:
                    return 16;
                  case QRMode.MODE_KANJI:
                    return 10;
                  default:
                    throw new Error("mode:" + mode);
                }
              } else if (type < 41) {
                switch (mode) {
                  case QRMode.MODE_NUMBER:
                    return 14;
                  case QRMode.MODE_ALPHA_NUM:
                    return 13;
                  case QRMode.MODE_8BIT_BYTE:
                    return 16;
                  case QRMode.MODE_KANJI:
                    return 12;
                  default:
                    throw new Error("mode:" + mode);
                }
              } else {
                throw new Error("type:" + type);
              }
            };
            _this.getLostPoint = function (qrcode) {
              var moduleCount = qrcode.getModuleCount(),
                lostPoint = 0;
              for (var row = 0; row < moduleCount; row += 1) {
                for (var col = 0; col < moduleCount; col += 1) {
                  var sameCount = 0,
                    dark = qrcode.isDark(row, col);
                  for (var r = -1; r <= 1; r += 1) {
                    if (row + r < 0 || moduleCount <= row + r) continue;
                    for (var c = -1; c <= 1; c += 1) {
                      if (col + c < 0 || moduleCount <= col + c) continue;
                      if (r == 0 && c == 0) continue;
                      if (dark == qrcode.isDark(row + r, col + c)) {
                        sameCount += 1;
                      }
                    }
                  }
                  if (sameCount > 5) {
                    lostPoint += 3 + sameCount - 5;
                  }
                }
              }
              for (var row = 0; row < moduleCount - 1; row += 1) {
                for (var col = 0; col < moduleCount - 1; col += 1) {
                  var count = 0;
                  if (qrcode.isDark(row, col)) count += 1;
                  if (qrcode.isDark(row + 1, col)) count += 1;
                  if (qrcode.isDark(row, col + 1)) count += 1;
                  if (qrcode.isDark(row + 1, col + 1)) count += 1;
                  if (count == 0 || count == 4) {
                    lostPoint += 3;
                  }
                }
              }
              for (var row = 0; row < moduleCount; row += 1) {
                for (var col = 0; col < moduleCount - 6; col += 1) {
                  if (
                    qrcode.isDark(row, col) &&
                    !qrcode.isDark(row, col + 1) &&
                    qrcode.isDark(row, col + 2) &&
                    qrcode.isDark(row, col + 3) &&
                    qrcode.isDark(row, col + 4) &&
                    !qrcode.isDark(row, col + 5) &&
                    qrcode.isDark(row, col + 6)
                  ) {
                    lostPoint += 40;
                  }
                }
              }
              for (var col = 0; col < moduleCount; col += 1) {
                for (var row = 0; row < moduleCount - 6; row += 1) {
                  if (
                    qrcode.isDark(row, col) &&
                    !qrcode.isDark(row + 1, col) &&
                    qrcode.isDark(row + 2, col) &&
                    qrcode.isDark(row + 3, col) &&
                    qrcode.isDark(row + 4, col) &&
                    !qrcode.isDark(row + 5, col) &&
                    qrcode.isDark(row + 6, col)
                  ) {
                    lostPoint += 40;
                  }
                }
              }
              var darkCount = 0;
              for (var col = 0; col < moduleCount; col += 1) {
                for (var row = 0; row < moduleCount; row += 1) {
                  if (qrcode.isDark(row, col)) {
                    darkCount += 1;
                  }
                }
              }
              var ratio =
                Math.abs((100 * darkCount) / moduleCount / moduleCount - 50) /
                5;
              lostPoint += ratio * 10;
              return lostPoint;
            };
            return _this;
          })(),
          QRMath = (function () {
            var EXP_TABLE = new Array(256),
              LOG_TABLE = new Array(256);
            for (var i = 0; i < 8; i += 1) {
              EXP_TABLE[i] = 1 << i;
            }
            for (var i = 8; i < 256; i += 1) {
              EXP_TABLE[i] =
                EXP_TABLE[i - 4] ^
                EXP_TABLE[i - 5] ^
                EXP_TABLE[i - 6] ^
                EXP_TABLE[i - 8];
            }
            for (var i = 0; i < 255; i += 1) {
              LOG_TABLE[EXP_TABLE[i]] = i;
            }
            var _this = {};
            _this.glog = function (n) {
              if (n < 1) {
                throw new Error("glog(" + n + ")");
              }
              return LOG_TABLE[n];
            };
            _this.gexp = function (n) {
              while (n < 0) {
                n += 255;
              }
              while (n >= 256) {
                n -= 255;
              }
              return EXP_TABLE[n];
            };
            return _this;
          })(),
          qrPolynomial = function (num, shift) {
            if (typeof num.length == "undefined") {
              throw new Error(num.length + "/" + shift);
            }
            var _num = (function () {
                var offset = 0;
                while (offset < num.length && num[offset] == 0) {
                  offset += 1;
                }
                var _num = new Array(num.length - offset + shift);
                for (var i = 0; i < num.length - offset; i += 1) {
                  _num[i] = num[i + offset];
                }
                return _num;
              })(),
              _this = {};
            _this.getAt = function (index) {
              return _num[index];
            };
            _this.getLength = function () {
              return _num.length;
            };
            _this.multiply = function (e) {
              var num = new Array(_this.getLength() + e.getLength() - 1);
              for (var i = 0; i < _this.getLength(); i += 1) {
                for (var j = 0; j < e.getLength(); j += 1) {
                  num[i + j] ^= QRMath.gexp(
                    QRMath.glog(_this.getAt(i)) + QRMath.glog(e.getAt(j))
                  );
                }
              }
              return qrPolynomial(num, 0);
            };
            _this.mod = function (e) {
              if (_this.getLength() - e.getLength() < 0) {
                return _this;
              }
              var ratio = QRMath.glog(_this.getAt(0)) - QRMath.glog(e.getAt(0)),
                num = new Array(_this.getLength());
              for (var i = 0; i < _this.getLength(); i += 1) {
                num[i] = _this.getAt(i);
              }
              for (var i = 0; i < e.getLength(); i += 1) {
                num[i] ^= QRMath.gexp(QRMath.glog(e.getAt(i)) + ratio);
              }
              return qrPolynomial(num, 0).mod(e);
            };
            return _this;
          },
          QRRSBlock = (function () {
            var RS_BLOCK_TABLE = [
                [1, 26, 19],
                [1, 26, 16],
                [1, 26, 13],
                [1, 26, 9],
                [1, 44, 34],
                [1, 44, 28],
                [1, 44, 22],
                [1, 44, 16],
                [1, 70, 55],
                [1, 70, 44],
                [2, 35, 17],
                [2, 35, 13],
                [1, 100, 80],
                [2, 50, 32],
                [2, 50, 24],
                [4, 25, 9],
                [1, 134, 108],
                [2, 67, 43],
                [2, 33, 15, 2, 34, 16],
                [2, 33, 11, 2, 34, 12],
                [2, 86, 68],
                [4, 43, 27],
                [4, 43, 19],
                [4, 43, 15],
                [2, 98, 78],
                [4, 49, 31],
                [2, 32, 14, 4, 33, 15],
                [4, 39, 13, 1, 40, 14],
                [2, 121, 97],
                [2, 60, 38, 2, 61, 39],
                [4, 40, 18, 2, 41, 19],
                [4, 40, 14, 2, 41, 15],
                [2, 146, 116],
                [3, 58, 36, 2, 59, 37],
                [4, 36, 16, 4, 37, 17],
                [4, 36, 12, 4, 37, 13],
                [2, 86, 68, 2, 87, 69],
                [4, 69, 43, 1, 70, 44],
                [6, 43, 19, 2, 44, 20],
                [6, 43, 15, 2, 44, 16],
                [4, 101, 81],
                [1, 80, 50, 4, 81, 51],
                [4, 50, 22, 4, 51, 23],
                [3, 36, 12, 8, 37, 13],
                [2, 116, 92, 2, 117, 93],
                [6, 58, 36, 2, 59, 37],
                [4, 46, 20, 6, 47, 21],
                [7, 42, 14, 4, 43, 15],
                [4, 133, 107],
                [8, 59, 37, 1, 60, 38],
                [8, 44, 20, 4, 45, 21],
                [12, 33, 11, 4, 34, 12],
                [3, 145, 115, 1, 146, 116],
                [4, 64, 40, 5, 65, 41],
                [11, 36, 16, 5, 37, 17],
                [11, 36, 12, 5, 37, 13],
                [5, 109, 87, 1, 110, 88],
                [5, 65, 41, 5, 66, 42],
                [5, 54, 24, 7, 55, 25],
                [11, 36, 12, 7, 37, 13],
                [5, 122, 98, 1, 123, 99],
                [7, 73, 45, 3, 74, 46],
                [15, 43, 19, 2, 44, 20],
                [3, 45, 15, 13, 46, 16],
                [1, 135, 107, 5, 136, 108],
                [10, 74, 46, 1, 75, 47],
                [1, 50, 22, 15, 51, 23],
                [2, 42, 14, 17, 43, 15],
                [5, 150, 120, 1, 151, 121],
                [9, 69, 43, 4, 70, 44],
                [17, 50, 22, 1, 51, 23],
                [2, 42, 14, 19, 43, 15],
                [3, 141, 113, 4, 142, 114],
                [3, 70, 44, 11, 71, 45],
                [17, 47, 21, 4, 48, 22],
                [9, 39, 13, 16, 40, 14],
                [3, 135, 107, 5, 136, 108],
                [3, 67, 41, 13, 68, 42],
                [15, 54, 24, 5, 55, 25],
                [15, 43, 15, 10, 44, 16],
                [4, 144, 116, 4, 145, 117],
                [17, 68, 42],
                [17, 50, 22, 6, 51, 23],
                [19, 46, 16, 6, 47, 17],
                [2, 139, 111, 7, 140, 112],
                [17, 74, 46],
                [7, 54, 24, 16, 55, 25],
                [34, 37, 13],
                [4, 151, 121, 5, 152, 122],
                [4, 75, 47, 14, 76, 48],
                [11, 54, 24, 14, 55, 25],
                [16, 45, 15, 14, 46, 16],
                [6, 147, 117, 4, 148, 118],
                [6, 73, 45, 14, 74, 46],
                [11, 54, 24, 16, 55, 25],
                [30, 46, 16, 2, 47, 17],
                [8, 132, 106, 4, 133, 107],
                [8, 75, 47, 13, 76, 48],
                [7, 54, 24, 22, 55, 25],
                [22, 45, 15, 13, 46, 16],
                [10, 142, 114, 2, 143, 115],
                [19, 74, 46, 4, 75, 47],
                [28, 50, 22, 6, 51, 23],
                [33, 46, 16, 4, 47, 17],
                [8, 152, 122, 4, 153, 123],
                [22, 73, 45, 3, 74, 46],
                [8, 53, 23, 26, 54, 24],
                [12, 45, 15, 28, 46, 16],
                [3, 147, 117, 10, 148, 118],
                [3, 73, 45, 23, 74, 46],
                [4, 54, 24, 31, 55, 25],
                [11, 45, 15, 31, 46, 16],
                [7, 146, 116, 7, 147, 117],
                [21, 73, 45, 7, 74, 46],
                [1, 53, 23, 37, 54, 24],
                [19, 45, 15, 26, 46, 16],
                [5, 145, 115, 10, 146, 116],
                [19, 75, 47, 10, 76, 48],
                [15, 54, 24, 25, 55, 25],
                [23, 45, 15, 25, 46, 16],
                [13, 145, 115, 3, 146, 116],
                [2, 74, 46, 29, 75, 47],
                [42, 54, 24, 1, 55, 25],
                [23, 45, 15, 28, 46, 16],
                [17, 145, 115],
                [10, 74, 46, 23, 75, 47],
                [10, 54, 24, 35, 55, 25],
                [19, 45, 15, 35, 46, 16],
                [17, 145, 115, 1, 146, 116],
                [14, 74, 46, 21, 75, 47],
                [29, 54, 24, 19, 55, 25],
                [11, 45, 15, 46, 46, 16],
                [13, 145, 115, 6, 146, 116],
                [14, 74, 46, 23, 75, 47],
                [44, 54, 24, 7, 55, 25],
                [59, 46, 16, 1, 47, 17],
                [12, 151, 121, 7, 152, 122],
                [12, 75, 47, 26, 76, 48],
                [39, 54, 24, 14, 55, 25],
                [22, 45, 15, 41, 46, 16],
                [6, 151, 121, 14, 152, 122],
                [6, 75, 47, 34, 76, 48],
                [46, 54, 24, 10, 55, 25],
                [2, 45, 15, 64, 46, 16],
                [17, 152, 122, 4, 153, 123],
                [29, 74, 46, 14, 75, 47],
                [49, 54, 24, 10, 55, 25],
                [24, 45, 15, 46, 46, 16],
                [4, 152, 122, 18, 153, 123],
                [13, 74, 46, 32, 75, 47],
                [48, 54, 24, 14, 55, 25],
                [42, 45, 15, 32, 46, 16],
                [20, 147, 117, 4, 148, 118],
                [40, 75, 47, 7, 76, 48],
                [43, 54, 24, 22, 55, 25],
                [10, 45, 15, 67, 46, 16],
                [19, 148, 118, 6, 149, 119],
                [18, 75, 47, 31, 76, 48],
                [34, 54, 24, 34, 55, 25],
                [20, 45, 15, 61, 46, 16],
              ],
              qrRSBlock = function (totalCount, dataCount) {
                var _this = {};
                _this.totalCount = totalCount;
                _this.dataCount = dataCount;
                return _this;
              },
              _this = {};
            _this.getRSBlocks = function (typeNumber, errorCorrectionLevel) {
              var rsBlock = getRsBlockTable(typeNumber, errorCorrectionLevel);
              if (typeof rsBlock == "undefined") {
                throw new Error(
                  "bad rs block @ typeNumber:" +
                    typeNumber +
                    "/errorCorrectionLevel:" +
                    errorCorrectionLevel
                );
              }
              var length = rsBlock.length / 3,
                list = [];
              for (var i = 0; i < length; i += 1) {
                var count = rsBlock[i * 3 + 0],
                  totalCount = rsBlock[i * 3 + 1],
                  dataCount = rsBlock[i * 3 + 2];
                for (var j = 0; j < count; j += 1) {
                  list.push(qrRSBlock(totalCount, dataCount));
                }
              }
              return list;
            };
            var getRsBlockTable = function (typeNumber, errorCorrectionLevel) {
              switch (errorCorrectionLevel) {
                case QRErrorCorrectionLevel.L:
                  return RS_BLOCK_TABLE[(typeNumber - 1) * 4 + 0];
                case QRErrorCorrectionLevel.M:
                  return RS_BLOCK_TABLE[(typeNumber - 1) * 4 + 1];
                case QRErrorCorrectionLevel.Q:
                  return RS_BLOCK_TABLE[(typeNumber - 1) * 4 + 2];
                case QRErrorCorrectionLevel.H:
                  return RS_BLOCK_TABLE[(typeNumber - 1) * 4 + 3];
                default:
                  return undefined;
              }
            };
            return _this;
          })(),
          qrBitBuffer = function () {
            var _buffer = [],
              _length = 0,
              _this = {};
            _this.getBuffer = function () {
              return _buffer;
            };
            _this.getAt = function (index) {
              var bufIndex = Math.floor(index / 8);
              return ((_buffer[bufIndex] >>> (7 - (index % 8))) & 1) == 1;
            };
            _this.put = function (num, length) {
              for (var i = 0; i < length; i += 1) {
                _this.putBit(((num >>> (length - i - 1)) & 1) == 1);
              }
            };
            _this.getLengthInBits = function () {
              return _length;
            };
            _this.putBit = function (bit) {
              var bufIndex = Math.floor(_length / 8);
              if (_buffer.length <= bufIndex) {
                _buffer.push(0);
              }
              if (bit) {
                _buffer[bufIndex] |= 0x80 >>> _length % 8;
              }
              _length += 1;
            };
            return _this;
          },
          qr8BitByte = function (data) {
            var _mode = QRMode.MODE_8BIT_BYTE,
              _data = data,
              _bytes = qrcode.stringToBytes(data),
              _this = {};
            _this.getMode = function () {
              return _mode;
            };
            _this.getLength = function (buffer) {
              return _bytes.length;
            };
            _this.write = function (buffer) {
              for (var i = 0; i < _bytes.length; i += 1) {
                buffer.put(_bytes[i], 8);
              }
            };
            return _this;
          };
        return qrcode;
      })();
      if (typeof module !== "undefined") {
        module.exports = qrcode;
      }
    </script>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        -webkit-text-size-adjust: 100%;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background: linear-gradient(
          135deg,
          #87ceeb 0%,
          #98fb98 50%,
          #f0e68c 100%
        );
        min-height: 100vh;
        padding: 10px;
        font-size: 16px;
        line-height: 1.5;
        -webkit-font-smoothing: antialiased;
      }

      .container {
        max-width: 500px;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        padding: 20px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        border: 4px solid #ffb6c1;
      }

      h1 {
        text-align: center;
        color: #ff69b4;
        font-size: 1.6em;
        font-weight: 700;
        margin-bottom: 15px;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
      }

      h2 {
        color: #ff69b4;
        font-size: 1.15em;
        font-weight: 600;
        margin: 15px 0 10px 0;
        border-bottom: 2px dashed #ffb6c1;
        padding-bottom: 5px;
      }

      .screen {
        display: none;
      }

      .screen.active {
        display: block;
      }

      .chicken-display {
        background: linear-gradient(180deg, #fffacd 0%, #fff8dc 100%);
        border: 3px solid #ffd700;
        border-radius: 20px;
        padding: 20px;
        margin: 10px 0;
        text-align: center;
        position: relative;
        overflow: hidden;
      }

      .chicken-display::before {
        content: "";
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(
          circle,
          rgba(255, 215, 0, 0.1) 0%,
          transparent 70%
        );
        animation: shimmer 3s ease-in-out infinite;
      }

      @keyframes shimmer {
        0%,
        100% {
          transform: rotate(0deg);
        }
        50% {
          transform: rotate(180deg);
        }
      }

      .chicken-art {
        font-size: 80px;
        line-height: 1;
        margin: 15px 0;
        position: relative;
        z-index: 1;
        animation: bounce 2s ease-in-out infinite;
      }

      @keyframes bounce {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-8px);
        }
      }

      .chicken-art.sleeping {
        animation: sleep 3s ease-in-out infinite;
      }

      @keyframes sleep {
        0%,
        100% {
          transform: translateY(0) rotate(-5deg);
        }
        50% {
          transform: translateY(2px) rotate(5deg);
        }
      }

      .chicken-art.sick {
        animation: wobble 1s ease-in-out infinite;
        filter: saturate(0.7);
      }

      @keyframes wobble {
        0%,
        100% {
          transform: rotate(-3deg);
        }
        50% {
          transform: rotate(3deg);
        }
      }

      .chicken-art.happy {
        animation: happy-bounce 0.5s ease-in-out infinite;
      }

      @keyframes happy-bounce {
        0%,
        100% {
          transform: translateY(0) scale(1);
        }
        50% {
          transform: translateY(-12px) scale(1.05);
        }
      }

      .chicken-stage-label {
        font-size: 0.9em;
        color: #888;
        margin-top: 5px;
        font-weight: 500;
      }

      .chicken-accessories {
        position: absolute;
        top: 5px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 20px;
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 3px;
        max-width: 140px;
        z-index: 2;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
      }

      .chicken-mood {
        position: absolute;
        top: 50%;
        right: 15px;
        transform: translateY(-50%);
        font-size: 28px;
        animation: float 2s ease-in-out infinite;
        z-index: 2;
      }

      @keyframes float {
        0%,
        100% {
          transform: translateY(-50%) translateX(0);
          opacity: 1;
        }
        50% {
          transform: translateY(-60%) translateX(5px);
          opacity: 0.8;
        }
      }

      .ground-decoration {
        margin-top: 10px;
        font-size: 20px;
        opacity: 0.7;
      }

      .status-bar {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        justify-content: center;
        margin: 10px 0;
      }

      .status-item {
        background: #ffe4e1;
        padding: 6px 12px;
        border-radius: 15px;
        font-size: 0.9em;
        font-weight: 500;
        border: 2px solid #ffb6c1;
      }

      .status-item.warning {
        background: #ffeb3b;
        border-color: #ffc107;
        animation: pulse 1s infinite;
      }

      .status-item.critical {
        background: #ff8a80;
        border-color: #ff5252;
        animation: shake 0.5s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
      }

      @keyframes shake {
        0%,
        100% {
          transform: translateX(0);
        }
        25% {
          transform: translateX(-2px);
        }
        75% {
          transform: translateX(2px);
        }
      }

      .btn {
        background: linear-gradient(180deg, #ff69b4, #ff1493);
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 25px;
        font-size: 1em;
        font-weight: 600;
        font-family: inherit;
        cursor: pointer;
        margin: 5px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        transition: transform 0.2s, box-shadow 0.2s;
      }

      .btn:hover,
      .btn:active {
        transform: translateY(-2px);
        box-shadow: 0 6px 8px rgba(0, 0, 0, 0.3);
      }

      .btn.small {
        padding: 8px 15px;
        font-size: 0.9em;
      }

      .btn.green {
        background: linear-gradient(180deg, #90ee90, #32cd32);
      }

      .btn.blue {
        background: linear-gradient(180deg, #87ceeb, #4169e1);
      }

      .btn.red {
        background: linear-gradient(180deg, #ff6b6b, #ee4444);
      }

      .btn.orange {
        background: linear-gradient(180deg, #ffb347, #ff8c00);
      }

      input,
      select {
        width: 100%;
        padding: 12px;
        margin: 8px 0;
        border: 3px solid #ffb6c1;
        border-radius: 15px;
        font-size: 16px;
        font-family: inherit;
        -webkit-appearance: none;
        appearance: none;
      }

      input:focus,
      select:focus {
        outline: none;
        border-color: #ff69b4;
        box-shadow: 0 0 10px rgba(255, 105, 180, 0.3);
      }

      label {
        display: block;
        font-weight: 600;
        color: #555;
        margin-top: 10px;
      }

      .breed-selector {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: center;
        margin: 10px 0;
      }

      .breed-option {
        background: #fff0f5;
        border: 3px solid #ffb6c1;
        border-radius: 15px;
        padding: 10px;
        cursor: pointer;
        text-align: center;
        width: 95px;
        transition: all 0.2s;
        font-weight: 500;
        font-size: 0.9em;
      }

      .breed-option:hover,
      .breed-option.selected {
        border-color: #ff69b4;
        background: #ffe4e1;
        transform: scale(1.05);
      }

      .breed-option .breed-icon {
        font-size: 2em;
      }

      .action-buttons {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 8px;
        margin: 15px 0;
      }

      .info-box {
        background: #e8f5e9;
        border: 2px solid #81c784;
        border-radius: 10px;
        padding: 12px;
        margin: 10px 0;
        font-size: 0.95em;
        line-height: 1.6;
      }

      .tips-section {
        background: linear-gradient(135deg, #fff8e1, #ffecb3);
        border: 1px dashed #ffc107;
        border-radius: 8px;
        padding: 8px 10px;
        margin: 0 0 10px 0;
        font-size: 0.8em;
        line-height: 1.4;
        text-align: center;
      }

      .tips-section .tip-icon {
        font-size: 1em;
        margin-right: 3px;
      }

      .tips-section .tip-title {
        font-weight: 700;
        color: #f57c00;
        margin-right: 5px;
      }

      .tips-section .tip-text {
        color: #5d4037;
      }

      .lifecycle-bar {
        background: #e0e0e0;
        border-radius: 10px;
        height: 20px;
        margin: 10px 0;
        overflow: hidden;
      }

      .lifecycle-progress {
        background: linear-gradient(90deg, #ffd700, #ffa500, #ff69b4);
        height: 100%;
        transition: width 0.5s;
      }

      .qr-container {
        text-align: center;
        padding: 15px;
        background: white;
        border-radius: 15px;
        margin: 10px 0;
      }

      #qrcode {
        display: inline-block;
        padding: 10px;
        background: white;
      }

      .friend-card {
        background: #fff0f5;
        border: 2px solid #ffb6c1;
        border-radius: 15px;
        padding: 12px;
        margin: 10px 0;
      }

      .friend-card .name {
        font-weight: bold;
        color: #ff69b4;
        font-size: 1.1em;
      }

      .tabs {
        display: flex;
        justify-content: center;
        gap: 5px;
        margin-bottom: 15px;
      }

      .tab {
        padding: 10px 15px;
        background: #ffe4e1;
        border: 2px solid #ffb6c1;
        border-radius: 15px 15px 0 0;
        cursor: pointer;
        font-size: 0.9em;
      }

      .tab.active {
        background: #ff69b4;
        color: white;
        border-color: #ff69b4;
      }

      .milestone-list {
        text-align: left;
        padding: 10px;
      }

      .milestone {
        padding: 5px 0;
        border-bottom: 1px dashed #ffb6c1;
      }

      .milestone.achieved {
        color: #32cd32;
      }

      .milestone.current {
        font-weight: bold;
        color: #ff69b4;
      }

      .hidden {
        display: none !important;
      }

      .message-popup {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 20px;
        border-radius: 20px;
        border: 4px solid #ff69b4;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        z-index: 1000;
        text-align: center;
        max-width: 300px;
      }

      .overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
      }

      .nav-bar {
        display: flex;
        justify-content: space-around;
        background: #ffe4e1;
        border-radius: 15px;
        padding: 10px;
        margin-bottom: 15px;
      }

      .nav-item {
        text-align: center;
        cursor: pointer;
        padding: 8px 12px;
        border-radius: 10px;
        font-weight: 500;
      }

      .nav-item.active {
        background: #ff69b4;
        color: white;
      }

      .nav-item .icon {
        font-size: 1.4em;
        display: block;
        margin-bottom: 2px;
      }

      .scan-area {
        border: 3px dashed #ff69b4;
        border-radius: 15px;
        padding: 20px;
        margin: 10px 0;
        text-align: center;
      }

      .qr-scanner-container {
        position: relative;
        width: 100%;
        max-width: 300px;
        margin: 15px auto;
        border-radius: 15px;
        overflow: hidden;
        background: #000;
      }

      .qr-scanner-container video {
        width: 100%;
        display: block;
        border-radius: 15px;
      }

      .qr-scanner-container canvas {
        display: none;
      }

      .scanner-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        pointer-events: none;
      }

      .scanner-frame {
        width: 70%;
        height: 70%;
        border: 3px solid #00ff00;
        border-radius: 15px;
        box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
        animation: pulse-scanner 2s infinite;
      }

      @keyframes pulse-scanner {
        0%,
        100% {
          border-color: #00ff00;
        }
        50% {
          border-color: #90ee90;
        }
      }

      .scanner-status {
        text-align: center;
        padding: 10px;
        font-weight: 600;
        color: #666;
      }

      .scanner-status.scanning {
        color: #32cd32;
      }

      .scanner-status.success {
        color: #00c851;
      }

      .scanner-status.error {
        color: #ff4444;
      }

      .scan-divider {
        display: flex;
        align-items: center;
        margin: 15px 0;
        color: #888;
      }

      .scan-divider::before,
      .scan-divider::after {
        content: "";
        flex: 1;
        border-bottom: 2px dashed #ddd;
      }

      .scan-divider span {
        padding: 0 15px;
        font-size: 0.9em;
      }

      textarea {
        width: 100%;
        padding: 12px;
        margin: 8px 0;
        border: 3px solid #ffb6c1;
        border-radius: 15px;
        font-size: 14px;
        font-family: ui-monospace, "SF Mono", Menlo, Monaco, monospace;
        resize: vertical;
        min-height: 80px;
        -webkit-appearance: none;
      }

      .money-display {
        background: linear-gradient(135deg, #ffd700 0%, #ffa500 100%);
        color: #333;
        padding: 8px 15px;
        border-radius: 20px;
        font-weight: 700;
        font-size: 1.1em;
        display: inline-block;
        margin: 10px 0;
        box-shadow: 0 3px 10px rgba(255, 165, 0, 0.3);
        border: 2px solid #ff8c00;
      }

      .status-bar {
        display: flex;
        justify-content: center;
        gap: 15px;
        flex-wrap: wrap;
        margin-bottom: 5px;
      }

      .daily-actions-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .daily-actions-display {
        background: linear-gradient(135deg, #87ceeb 0%, #4169e1 100%);
        color: white;
        padding: 8px 15px;
        border-radius: 20px;
        font-weight: 700;
        font-size: 1.1em;
        display: inline-block;
        margin: 10px 0 2px 0;
        box-shadow: 0 3px 10px rgba(65, 105, 225, 0.3);
        border: 2px solid #1e90ff;
      }

      .daily-actions-legend {
        font-size: 0.7em;
        color: #888;
        margin-bottom: 5px;
      }

      .daily-actions-display.low {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a5a 100%);
        border-color: #dc3545;
        animation: pulse 1s infinite;
      }

      .daily-actions-display.empty {
        background: linear-gradient(135deg, #808080 0%, #696969 100%);
        border-color: #555;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
      }

      .health-indicators {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
        margin: 15px 0;
        padding: 15px;
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        border-radius: 15px;
        border: 2px solid #dee2e6;
      }

      .health-indicator {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .health-indicator-label {
        font-size: 0.85em;
        font-weight: 600;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .health-indicator-bar {
        height: 10px;
        background: #e0e0e0;
        border-radius: 5px;
        overflow: hidden;
      }

      .health-indicator-fill {
        height: 100%;
        border-radius: 5px;
        transition: width 0.3s ease, background 0.3s ease;
      }

      .health-indicator-fill.high {
        background: linear-gradient(90deg, #4caf50, #8bc34a);
      }

      .health-indicator-fill.medium {
        background: linear-gradient(90deg, #ff9800, #ffc107);
      }

      .health-indicator-fill.low {
        background: linear-gradient(90deg, #f44336, #ff5722);
        animation: pulse 1s infinite;
      }

      .health-up-arrow {
        display: inline-block;
        animation: bounce-up 0.5s ease-in-out infinite;
        color: #2e7d32;
      }

      @keyframes bounce-up {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-3px);
        }
      }

      .overall-health {
        grid-column: 1 / -1;
        text-align: center;
        padding: 12px;
        background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
        border-radius: 12px;
        border: 2px solid #81c784;
        margin-bottom: 5px;
      }

      .overall-health.warning {
        background: linear-gradient(135deg, #fff3e0, #ffe0b2);
        border-color: #ffb74d;
      }

      .overall-health.critical {
        background: linear-gradient(135deg, #ffebee, #ffcdd2);
        border-color: #e57373;
        animation: pulse 1s infinite;
      }

      .overall-health-label {
        font-size: 0.9em;
        color: #666;
        margin-bottom: 5px;
      }

      .overall-health-value {
        font-size: 1.8em;
        font-weight: 700;
      }

      .overall-health-value.high {
        color: #2e7d32;
      }
      .overall-health-value.medium {
        color: #f57c00;
      }
      .overall-health-value.low {
        color: #c62828;
      }

      .shop-categories {
        display: flex;
        gap: 8px;
        margin: 15px 0;
        justify-content: center;
        flex-wrap: wrap;
      }

      .category-btn {
        padding: 10px 15px;
        border: 3px solid #ddd;
        border-radius: 20px;
        background: white;
        font-size: 0.9em;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
      }

      .category-btn:active {
        transform: scale(0.95);
      }

      .category-btn.active {
        border-color: #ff69b4;
        background: linear-gradient(135deg, #fff0f5, #ffe4ec);
        color: #d63384;
      }

      #cat-decorations.active {
        border-color: #ff69b4;
        background: linear-gradient(135deg, #fff0f5, #ffe4ec);
      }

      #cat-health.active {
        border-color: #32cd32;
        background: linear-gradient(135deg, #f0fff0, #e0ffe0);
        color: #228b22;
      }

      #cat-toys.active {
        border-color: #4169e1;
        background: linear-gradient(135deg, #f0f8ff, #e0ecff);
        color: #1e40af;
      }

      .shop-item {
        background: #fff9e6;
        border: 3px solid #ffd700;
        border-radius: 15px;
        padding: 12px;
        margin: 10px 0;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .shop-item.decorations {
        background: #fff0f5;
        border-color: #ff69b4;
      }

      .shop-item.health {
        background: #f0fff0;
        border-color: #32cd32;
      }

      .shop-item.toys {
        background: #f0f8ff;
        border-color: #4169e1;
      }

      .shop-item.owned {
        background: #e8f5e9;
        border-color: #81c784;
        opacity: 0.8;
      }

      .shop-item .item-icon {
        font-size: 2em;
        width: 50px;
        text-align: center;
      }

      .shop-item .item-info {
        flex: 1;
      }

      .shop-item .item-name {
        font-weight: 600;
        color: #333;
      }

      .shop-item .item-desc {
        font-size: 0.85em;
        color: #666;
      }

      .shop-item .item-price {
        font-weight: 700;
        color: #ff8c00;
      }

      .shop-item .owned-badge {
        background: #81c784;
        color: white;
        padding: 4px 10px;
        border-radius: 10px;
        font-size: 0.8em;
        font-weight: 600;
      }

      .inventory-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: center;
        margin: 10px 0;
      }

      .inventory-item {
        background: #fff0f5;
        border: 2px solid #ffb6c1;
        border-radius: 12px;
        padding: 10px;
        text-align: center;
        width: 70px;
      }

      .inventory-item .item-emoji {
        font-size: 1.8em;
      }

      .coin-earn {
        color: #ff8c00;
        font-weight: 600;
        animation: coinPop 0.5s ease-out;
      }

      @keyframes coinPop {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.3);
        }
        100% {
          transform: scale(1);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Welcome Screen -->
      <div id="welcome-screen" class="screen active">
        <h1>üêî My Virtual Chicken üêî</h1>
        <div
          style="
            text-align: center;
            color: #999;
            font-size: 0.8em;
            margin-top: -10px;
          "
        >
          v<span id="version-display">0.11.0</span>
        </div>
        <div
          style="
            font-size: 80px;
            text-align: center;
            margin: 20px 0;
            animation: bounce 2s ease-in-out infinite;
          "
        >
          üêî
        </div>
        <div style="text-align: center; font-size: 20px; margin-bottom: 15px">
          üåæüåøüåæüåøüåæ
        </div>
        <p style="text-align: center; margin: 15px 0; color: #666">
          Welcome to the cutest chicken game ever! üå∏<br />
          Raise your own virtual chicken!
        </p>
        <div style="text-align: center">
          <button class="btn" onclick="showScreen('create-screen')">
            üê£ New Chicken
          </button>
          <button class="btn green" onclick="loadExistingChicken()">
            üìÇ Continue
          </button>
        </div>
      </div>

      <!-- Create Chicken Screen -->
      <div id="create-screen" class="screen">
        <h1>üê£ Create Your Chicken üê£</h1>

        <label>Your Name (Owner):</label>
        <input
          type="text"
          id="owner-name"
          placeholder="Enter your name..."
          maxlength="20"
        />

        <label>Chicken's Name:</label>
        <input
          type="text"
          id="chicken-name"
          placeholder="Name your chicken..."
          maxlength="20"
        />

        <label>Choose a Breed:</label>
        <div class="breed-selector">
          <div
            class="breed-option"
            data-breed="isa-brown"
            onclick="selectBreed(this)"
          >
            <div class="breed-icon">üêî</div>
            <div>ISA Brown</div>
          </div>
          <div
            class="breed-option"
            data-breed="silkie"
            onclick="selectBreed(this)"
          >
            <div class="breed-icon">üê•</div>
            <div>Silkie</div>
          </div>
          <div
            class="breed-option"
            data-breed="leghorn"
            onclick="selectBreed(this)"
          >
            <div class="breed-icon">üêì</div>
            <div>Leghorn</div>
          </div>
          <div
            class="breed-option"
            data-breed="plymouth"
            onclick="selectBreed(this)"
          >
            <div class="breed-icon">üê§</div>
            <div>Plymouth Rock</div>
          </div>
          <div
            class="breed-option"
            data-breed="orpington"
            onclick="selectBreed(this)"
          >
            <div class="breed-icon">ü™∫</div>
            <div>Orpington</div>
          </div>
        </div>

        <div style="text-align: center; margin-top: 20px">
          <button class="btn" onclick="createChicken()">
            ü•ö Hatch My Chicken!
          </button>
          <button class="btn blue" onclick="showScreen('welcome-screen')">
            ‚¨ÖÔ∏è Back
          </button>
        </div>
      </div>

      <!-- Main Game Screen -->
      <div id="game-screen" class="screen">
        <div class="status-bar">
          <div class="money-display">üí∞ $<span id="money-amount">5</span></div>
          <div class="daily-actions-wrapper">
            <div class="daily-actions-display" id="daily-actions-display">
              ‚ö° <span id="daily-actions-remaining">10</span>/10 today
            </div>
            <div class="daily-actions-legend">
              remaining allowed actions today
            </div>
          </div>
        </div>

        <div class="nav-bar">
          <div
            class="nav-item active"
            onclick="showTab('chicken')"
            id="nav-chicken"
          >
            <div class="icon">üêî</div>
            <div>Chicken</div>
          </div>
          <div class="nav-item" onclick="showTab('shop')" id="nav-shop">
            <div class="icon">üõí</div>
            <div>Shop</div>
          </div>
          <div class="nav-item" onclick="showTab('friends')" id="nav-friends">
            <div class="icon">üë•</div>
            <div>Friends</div>
          </div>
          <div class="nav-item" onclick="showTab('share')" id="nav-share">
            <div class="icon">üì±</div>
            <div>Share</div>
          </div>
        </div>

        <!-- Chicken Tab -->
        <div id="chicken-tab" class="tab-content">
          <div class="tips-section" id="tips-section">
            <span class="tip-icon">üí°</span><span class="tip-title">TIP:</span>
            <span class="tip-text"
              >Use <strong>Caring Actions</strong> below to advance time!</span
            >
          </div>

          <div class="chicken-display">
            <div class="chicken-accessories" id="chicken-accessories"></div>
            <div class="chicken-mood" id="chicken-mood"></div>
            <div id="chicken-art" class="chicken-art">üê£</div>
            <div class="chicken-stage-label" id="chicken-stage-label">
              Baby Chick
            </div>
            <div class="ground-decoration">üåøüåæüåøüåæüåø</div>
            <h2 id="display-name">Clucky</h2>
            <p id="display-breed" style="color: #888">ISA Brown</p>
            <p id="display-owner" style="color: #666; font-size: 0.9em">
              Owner: You
            </p>
          </div>

          <div class="info-box">
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 8px;
              "
            >
              <div>
                <strong>üåü Life Stage:</strong> <span id="life-stage">Egg</span>
              </div>
              <div
                style="
                  background: linear-gradient(135deg, #fff3e0, #ffe0b2);
                  padding: 8px 15px;
                  border-radius: 15px;
                  font-weight: 700;
                  font-size: 1.1em;
                  border: 2px solid #ffb74d;
                  box-shadow: 0 2px 8px rgba(255, 183, 77, 0.3);
                "
              >
                üìÖ Day <span id="chicken-age">0</span>
              </div>
            </div>
            <div
              style="
                font-size: 0.9em;
                color: #666;
                margin: 10px 0;
                padding: 10px;
                background: #f5f5f5;
                border-radius: 10px;
                text-align: center;
              "
              id="action-progress"
            >
              ‚ú® Each caring action advances time by <strong>+5 days</strong>
            </div>
            <div class="lifecycle-bar">
              <div
                class="lifecycle-progress"
                id="lifecycle-progress"
                style="width: 5%"
              ></div>
            </div>
          </div>

          <h2>‚ù§Ô∏è How's My Chicken?</h2>
          <div class="status-bar" id="status-bar">
            <span class="status-item">üòä Happy</span>
          </div>

          <div class="health-indicators" id="health-indicators">
            <div
              class="overall-health"
              id="overall-health"
              onclick="secretResetTap()"
            >
              <div class="overall-health-label">üèÜ Overall Health</div>
              <div class="overall-health-value high" id="overall-health-value">
                100%
              </div>
            </div>
            <div class="health-indicator">
              <div class="health-indicator-label">
                <span>üåæ Hunger</span>
                <span id="hunger-percent">100%</span>
              </div>
              <div class="health-indicator-bar">
                <div
                  class="health-indicator-fill high"
                  id="hunger-bar"
                  style="width: 100%"
                ></div>
              </div>
            </div>
            <div class="health-indicator">
              <div class="health-indicator-label">
                <span>üíß Thirst</span>
                <span id="thirst-percent">100%</span>
              </div>
              <div class="health-indicator-bar">
                <div
                  class="health-indicator-fill high"
                  id="thirst-bar"
                  style="width: 100%"
                ></div>
              </div>
            </div>
            <div class="health-indicator">
              <div class="health-indicator-label">
                <span>üõÅ Cleanliness</span>
                <span id="cleanliness-percent">100%</span>
              </div>
              <div class="health-indicator-bar">
                <div
                  class="health-indicator-fill high"
                  id="cleanliness-bar"
                  style="width: 100%"
                ></div>
              </div>
            </div>
            <div class="health-indicator">
              <div class="health-indicator-label">
                <span>üò¥ Sleep</span>
                <span id="sleep-percent">100%</span>
              </div>
              <div class="health-indicator-bar">
                <div
                  class="health-indicator-fill high"
                  id="sleep-bar"
                  style="width: 100%"
                ></div>
              </div>
            </div>
            <div class="health-indicator">
              <div class="health-indicator-label">
                <span>üòä Happiness</span>
                <span id="happiness-percent">100%</span>
              </div>
              <div class="health-indicator-bar">
                <div
                  class="health-indicator-fill high"
                  id="happiness-bar"
                  style="width: 100%"
                ></div>
              </div>
            </div>
            <div class="health-indicator">
              <div class="health-indicator-label">
                <span>ü¶∂ Exercise</span>
                <span id="exercise-percent">100%</span>
              </div>
              <div class="health-indicator-bar">
                <div
                  class="health-indicator-fill high"
                  id="exercise-bar"
                  style="width: 100%"
                ></div>
              </div>
            </div>
          </div>

          <h2>üéÆ Caring Actions</h2>
          <div class="action-buttons">
            <button class="btn small green" onclick="doAction('feed')">
              üåæ Feed
            </button>
            <button class="btn small blue" onclick="doAction('water')">
              üíß Water
            </button>
            <button class="btn small orange" onclick="doAction('dustbath')">
              üõÅ Dust Bath
            </button>
            <button class="btn small" onclick="doAction('play')">
              üéæ Play
            </button>
            <button class="btn small green" onclick="doAction('sleep')">
              üò¥ Sleep
            </button>
            <button class="btn small blue" onclick="doAction('flap')">
              ü™Ω Let Flap
            </button>
          </div>

          <div class="daily-actions-wrapper" style="margin-top: 15px">
            <div
              class="daily-actions-display"
              id="daily-actions-display-bottom"
            >
              ‚ö° <span id="daily-actions-remaining-bottom">10</span>/10 today
            </div>
            <div class="daily-actions-legend">
              remaining allowed actions today
            </div>
          </div>

          <h2>üèÜ Milestones</h2>
          <div class="milestone-list" id="milestone-list"></div>
        </div>

        <!-- Shop Tab -->
        <div id="shop-tab" class="tab-content hidden">
          <h2>üõí Chicken Shop</h2>
          <p style="text-align: center; color: #666; margin: 10px 0">
            Buy cute stuff for your chicken! üéÅ
          </p>

          <div class="shop-categories">
            <button
              class="category-btn active"
              onclick="showShopCategory('decorations')"
              id="cat-decorations"
            >
              ‚ú® Decorations
            </button>
            <button
              class="category-btn"
              onclick="showShopCategory('health')"
              id="cat-health"
            >
              üíä Health
            </button>
            <button
              class="category-btn"
              onclick="showShopCategory('toys')"
              id="cat-toys"
            >
              üéÆ Toys
            </button>
          </div>

          <div id="shop-items"></div>

          <h2>üéí My Items</h2>
          <div id="inventory" class="inventory-grid">
            <p style="text-align: center; color: #888; width: 100%">
              No items yet!
            </p>
          </div>
        </div>

        <!-- Friends Tab -->
        <div id="friends-tab" class="tab-content hidden">
          <h2>üë• My Chicken Friends</h2>

          <div class="scan-area">
            <p>üì∏ Scan a friend's QR code with your camera:</p>

            <div
              class="qr-scanner-container"
              id="scanner-container"
              style="display: none"
            >
              <video id="scanner-video" playsinline></video>
              <canvas id="scanner-canvas"></canvas>
              <div class="scanner-overlay">
                <div class="scanner-frame"></div>
              </div>
            </div>
            <div id="scanner-status" class="scanner-status"></div>

            <button class="btn blue" id="scan-btn" onclick="toggleQRScanner()">
              üì∑ Start Camera Scan
            </button>

            <div class="scan-divider"><span>OR</span></div>

            <p style="margin-top: 10px; font-size: 0.9em; color: #888">
              Paste your friend's code manually:
            </p>
            <textarea
              id="friend-code-input"
              placeholder="Paste chicken code here..."
            ></textarea>
            <button class="btn green" onclick="addFriend()">
              ‚ûï Add Friend
            </button>
          </div>

          <div id="friends-list">
            <p style="text-align: center; color: #888; margin: 20px 0">
              No friends yet! üê£<br />
              Scan a friend's code to add them!
            </p>
          </div>
        </div>

        <!-- Share Tab -->
        <div id="share-tab" class="tab-content hidden">
          <h2>üì± Share Your Chicken</h2>
          <p style="text-align: center; color: #666; margin: 10px 0">
            Show this code to your friends so they can add your chicken! üêî
          </p>

          <div class="qr-container">
            <div
              id="qrcode"
              onclick="handleQRTap()"
              style="cursor: pointer"
            ></div>
            <p style="margin-top: 10px; font-size: 0.8em; color: #888">
              Scan with camera or copy the code below
            </p>
          </div>

          <div style="text-align: center">
            <button class="btn small blue" onclick="copyChickenCode()">
              üìã Copy Code
            </button>
          </div>

          <div class="info-box" style="margin-top: 15px">
            <strong>Your Chicken Code:</strong>
            <textarea
              id="chicken-code"
              readonly
              style="min-height: 60px; font-size: 0.8em"
            ></textarea>
          </div>
        </div>
      </div>
    </div>

    <!-- Message Popup -->
    <div id="overlay" class="overlay hidden" onclick="hidePopup()"></div>
    <div id="popup" class="message-popup hidden">
      <div id="popup-content"></div>
      <button class="btn small" onclick="hidePopup()">OK! üëç</button>
    </div>

    <script>
      // ============= GAME DATA =============
      const BREEDS = {
        "isa-brown": { name: "ISA Brown", color: "#8B4513", eggColor: "brown" },
        silkie: { name: "Silkie", color: "#F5F5DC", eggColor: "cream" },
        leghorn: { name: "Leghorn", color: "#FFFFFF", eggColor: "white" },
        plymouth: {
          name: "Plymouth Rock",
          color: "#808080",
          eggColor: "brown",
        },
        orpington: { name: "Orpington", color: "#FFD700", eggColor: "brown" },
      };

      const MILESTONES = [
        { day: 0, name: "ü•ö Egg", stage: "egg" },
        { day: 20, name: "üê£ Hatching!", stage: "hatching" },
        { day: 27, name: "üê§ One Week Old", stage: "chick-week" },
        { day: 40, name: "üê• Fluffy Chick", stage: "chick" },
        { day: 50, name: "üêî One Month Old", stage: "pullet" },
        { day: 80, name: "üêî Two Months Old", stage: "pullet2" },
        { day: 110, name: "üêî Three Months Old", stage: "teenager" },
        { day: 150, name: "ü•ö First Egg!", stage: "laying" },
        { day: 180, name: "üêì Six Months Old", stage: "adult" },
        { day: 365, name: "üéÇ One Year Old!", stage: "mature" },
      ];

      const STATUSES = {
        happy: { icon: "üòä", text: "Happy", priority: 0 },
        hungry: { icon: "üçΩÔ∏è", text: "Hungry", priority: 2 },
        thirsty: { icon: "üíß", text: "Needs Water", priority: 2 },
        dusty: { icon: "üõÅ", text: "Needs Dust Bath", priority: 1 },
        sleepy: { icon: "üò¥", text: "Sleepy", priority: 1 },
        wantFlap: { icon: "ü™Ω", text: "Wants to Flap", priority: 1 },
        sick: { icon: "ü§í", text: "Sick", priority: 3 },
        bored: { icon: "üòê", text: "Bored", priority: 1 },
      };

      // Shop items organized by category
      const SHOP_CATEGORIES = {
        decorations: {
          name: "‚ú® Decorations",
          description: "Make your chicken pretty!",
          color: "#ff69b4",
        },
        health: {
          name: "üíä Health",
          description: "Keep your chicken healthy!",
          color: "#32cd32",
        },
        toys: {
          name: "üéÆ Toys",
          description: "Fun stuff to play with!",
          color: "#4169e1",
        },
      };

      const SHOP_ITEMS = {
        // === DECORATIONS ===
        headband: {
          id: "headband",
          name: "Flower Headband",
          icon: "üå∏",
          price: 2,
          category: "decorations",
          description: "A cute flower crown for your chicken!",
          effect: { happiness: 5 },
          displayIcon: "üå∏",
        },
        jumper: {
          id: "jumper",
          name: "Cozy Jumper",
          icon: "üß•",
          price: 3,
          category: "decorations",
          description: "A warm knitted sweater. So stylish!",
          effect: { happiness: 5 },
          displayIcon: "üß∂",
        },
        necklace: {
          id: "necklace",
          name: "Pearl Necklace",
          icon: "üìø",
          price: 2,
          category: "decorations",
          description: "Elegant pearls for a fancy chicken!",
          effect: { happiness: 5 },
          displayIcon: "üíé",
        },
        nametag: {
          id: "nametag",
          name: "Custom Nametag",
          icon: "üè∑Ô∏è",
          price: 1,
          category: "decorations",
          description: "Everyone will know your chicken's name!",
          effect: { happiness: 3 },
          displayIcon: "üè∑Ô∏è",
        },
        "duck-kit": {
          id: "duck-kit",
          name: "Duck Disguise Kit",
          icon: "ü¶Ü",
          price: 3,
          category: "decorations",
          description: "Quack quack! Pretend to be a duck!",
          effect: { happiness: 8 },
          displayIcon: "ü¶Ü",
        },
        "panda-face": {
          id: "panda-face",
          name: "Panda Face Mask",
          icon: "üêº",
          price: 3,
          category: "decorations",
          description: "The cutest panda-chicken ever!",
          effect: { happiness: 8 },
          displayIcon: "üêº",
        },
        "eye-patch": {
          id: "eye-patch",
          name: "Pirate Eye Patch",
          icon: "üè¥‚Äç‚ò†Ô∏è",
          price: 2,
          category: "decorations",
          description: "Arrr! A fearsome pirate chicken!",
          effect: { happiness: 6 },
          displayIcon: "‚ò†Ô∏è",
        },
        "fake-eyebrows": {
          id: "fake-eyebrows",
          name: "Silly Eyebrows",
          icon: "ü§®",
          price: 1,
          category: "decorations",
          description: "Bushy funny eyebrows! So goofy!",
          effect: { happiness: 4 },
          displayIcon: "ü•∏",
        },
        "angry-eyebrows": {
          id: "angry-eyebrows",
          name: "Angry Eyebrows",
          icon: "üò†",
          price: 1,
          category: "decorations",
          description: "Grrrr! Look tough and serious!",
          effect: { happiness: 4 },
          displayIcon: "üò§",
        },
        "fascinator-hat": {
          id: "fascinator-hat",
          name: "Fancy Fascinator",
          icon: "üëí",
          price: 3,
          category: "decorations",
          description: "An elegant hat with feathers! So fancy!",
          effect: { happiness: 7 },
          displayIcon: "üé©",
        },
        "cute-face-kit": {
          id: "cute-face-kit",
          name: "Cute Face Kit",
          icon: "ü•∞",
          price: 2,
          category: "decorations",
          description: "Rosy cheeks, sparkly eyes, so kawaii!",
          effect: { happiness: 6 },
          displayIcon: "‚ú®",
        },
        "unicorn-horn": {
          id: "unicorn-horn",
          name: "Unicorn Horn",
          icon: "ü¶Ñ",
          price: 4,
          category: "decorations",
          description: "A magical sparkly horn! So majestic!",
          effect: { happiness: 10 },
          displayIcon: "ü¶Ñ",
        },
        "superhero-cape": {
          id: "superhero-cape",
          name: "Superhero Cape",
          icon: "ü¶∏",
          price: 3,
          category: "decorations",
          description: "Up, up and away! Super Chicken!",
          effect: { happiness: 8 },
          displayIcon: "ü¶∏",
        },
        "bow-tie": {
          id: "bow-tie",
          name: "Fancy Bow Tie",
          icon: "üéÄ",
          price: 2,
          category: "decorations",
          description: "Looking dapper and sophisticated!",
          effect: { happiness: 5 },
          displayIcon: "üéÄ",
        },
        crown: {
          id: "crown",
          name: "Royal Crown",
          icon: "üëë",
          price: 5,
          category: "decorations",
          description: "All hail the Chicken Queen/King!",
          effect: { happiness: 12 },
          displayIcon: "üëë",
        },
        // === HEALTH ===
        vitamins: {
          id: "vitamins",
          name: "Daily Vitamins",
          icon: "üíä",
          price: 2,
          category: "health",
          description: "Boosts overall health! Slower hunger decay.",
          effect: { hungerDecayReduction: 0.3 },
          displayIcon: "üíä",
        },
        "feather-polish": {
          id: "feather-polish",
          name: "Feather Polish",
          icon: "‚ú®",
          price: 2,
          category: "health",
          description: "Shiny feathers! Slower cleanliness decay.",
          effect: { cleanlinessDecayReduction: 0.3 },
          displayIcon: "‚ú®",
        },
        "growth-vitamin": {
          id: "growth-vitamin",
          name: "Growth Vitamin",
          icon: "üå±",
          price: 3,
          category: "health",
          description: "Helps your chicken grow strong!",
          effect: { happiness: 10 },
          displayIcon: "üå±",
        },
        "deworm-tablets": {
          id: "deworm-tablets",
          name: "De-worm Tablets",
          icon: "üíâ",
          price: 2,
          category: "health",
          description: "Keeps parasites away! Reduces sickness.",
          effect: { sickReduction: 0.5 },
          displayIcon: "ü©∫",
        },
        // === TOYS ===
        "fake-worm": {
          id: "fake-worm",
          name: "Fake Worm",
          icon: "ü™±",
          price: 1,
          category: "toys",
          description: "A wiggly toy worm! +5 happiness.",
          effect: { happiness: 5 },
          displayIcon: "ü™±",
        },
        "robot-friend": {
          id: "robot-friend",
          name: "Robot Chicken Friend",
          icon: "ü§ñ",
          price: 4,
          category: "toys",
          description: "A robot buddy! Slower boredom.",
          effect: { happinessDecayReduction: 0.3 },
          displayIcon: "ü§ñ",
        },
        "walky-talky": {
          id: "walky-talky",
          name: "Chicken Walky-Talky",
          icon: "üìª",
          price: 3,
          category: "toys",
          description: "Bawk bawk into the microphone!",
          effect: { happiness: 8 },
          displayIcon: "üìª",
        },
        "chicken-photo": {
          id: "chicken-photo",
          name: "Photo of Itself",
          icon: "üñºÔ∏è",
          price: 2,
          category: "toys",
          description: "A framed selfie! Your chicken loves it.",
          effect: { happiness: 6 },
          displayIcon: "üì∏",
        },
        mirror: {
          id: "mirror",
          name: "Chicken Mirror",
          icon: "ü™û",
          price: 2,
          category: "toys",
          description: "Who's that pretty chicken? Less boredom!",
          effect: { happinessDecayReduction: 0.2 },
          displayIcon: "ü™û",
        },
      };

      // Cute emoji graphics for different stages
      const CHICKEN_GRAPHICS = {
        egg: {
          emoji: "ü•ö",
          label: "Egg",
          size: "70px",
          ground: "üåæü™πüåæ",
        },
        hatching: {
          emoji: "üê£",
          label: "Hatching!",
          size: "75px",
          ground: "üåæ‚ú®üåæ",
          animation: "wobble",
        },
        "chick-week": {
          emoji: "üê§",
          label: "1 Week Old Chick",
          size: "80px",
          ground: "üåøüåæüåø",
        },
        chick: {
          emoji: "üê•",
          label: "Fluffy Chick",
          size: "80px",
          ground: "üåøüåæüåøüåæ",
        },
        pullet: {
          emoji: "üê•",
          label: "Young Pullet",
          size: "85px",
          ground: "üåæüåøüåæüåø",
        },
        pullet2: {
          emoji: "üêî",
          label: "Growing Pullet",
          size: "90px",
          ground: "üåøüåæüåøüåæüåø",
        },
        teenager: {
          emoji: "üêî",
          label: "Teenage Chicken",
          size: "95px",
          ground: "üåæüåøüåæüåøüåæ",
        },
        laying: {
          emoji: "üêî",
          label: "Laying Hen",
          size: "100px",
          ground: "üåøü•öüåøü•öüåø",
          accessory: "ü•ö",
        },
        adult: {
          emoji: "üêî",
          label: "Adult Chicken",
          size: "100px",
          ground: "üåæüåøüåæüåøüåæüåø",
        },
        mature: {
          emoji: "üêî",
          label: "Mature Chicken ‚≠ê",
          size: "105px",
          ground: "üåø‚≠êüåæ‚≠êüåø",
          accessory: "üèÜ",
        },
        rooster: {
          emoji: "üêì",
          label: "Proud Rooster",
          size: "105px",
          ground: "üåæüåøüåæüåøüåæ",
        },
      };

      // Mood indicators
      const MOOD_EMOJIS = {
        happy: ["üíï", "‚ú®", "üåü", "üíñ"],
        hungry: ["üí®", "üåæ", "‚ùì"],
        thirsty: ["üíß", "üí¶"],
        sleepy: ["üí§", "üåô", "‚≠ê"],
        sick: ["ü©π", "üí®"],
        dusty: ["üí®", "üèùÔ∏è"],
        bored: ["üí®", "‚ùì"],
        wantFlap: ["üë•", "ü™∂"],
      };

      // ============= GAME STATE =============
      const GAME_VERSION = "0.14.0";
      const DAILY_ACTION_LIMIT = 10;

      let gameState = {
        chicken: null,
        friends: [],
        lastUpdate: null,
        money: 5,
        inventory: [],
        actionCount: 0, // Track actions for time passing
        dailyActions: 0, // Track daily actions for quota
        dailyActionsDate: null, // The date of last action (YYYY-MM-DD)
      };

      let selectedBreed = null;

      // ============= SECRET RESET =============
      let qrTapCount = 0;
      let qrTapTimer = null;

      function handleQRTap() {
        qrTapCount++;

        // Reset counter after 3 seconds of no taps
        clearTimeout(qrTapTimer);
        qrTapTimer = setTimeout(() => {
          qrTapCount = 0;
        }, 3000);

        if (qrTapCount >= 5) {
          qrTapCount = 0;
          clearTimeout(qrTapTimer);
          showResetConfirmation();
        }
      }

      function showResetConfirmation() {
        const popupContent = `
          <div style="text-align: center;">
            <div style="font-size: 2em; margin-bottom: 10px;">üîÑ Secret Reset</div>
            <p style="color: #666; margin-bottom: 15px;">Are you SURE you want to reset everything?<br>Your chicken, items, and friends will be deleted!</p>
            <div style="display: flex; gap: 10px; justify-content: center;">
              <button class="btn small" onclick="hidePopup()" style="background: #95a5a6;">Cancel</button>
              <button class="btn small" onclick="performSecretReset()" style="background: #e74c3c;">üóëÔ∏è Reset All</button>
            </div>
          </div>
        `;
        document.getElementById("popup-content").innerHTML = popupContent;
        document.getElementById("popup").classList.remove("hidden");
        document.getElementById("overlay").classList.remove("hidden");
        // Remove the default onclick from overlay for this popup
        document.getElementById("overlay").onclick = null;
      }

      function performSecretReset() {
        // Clear all game data
        localStorage.removeItem("chickenGame");
        gameState = {
          chicken: null,
          friends: [],
          lastUpdate: null,
          money: 5,
          inventory: [],
          actionCount: 0,
          dailyActions: 0,
          dailyActionsDate: null,
        };
        hidePopup();
        // Restore overlay onclick
        document.getElementById("overlay").onclick = hidePopup;
        showPopup("üê£ Game reset complete!<br>Starting fresh...");
        setTimeout(() => {
          hidePopup();
          showScreen("setup-screen");
        }, 1500);
      }

      // ============= DAILY QUOTA MANAGEMENT =============
      function getTodayDateString() {
        return new Date().toISOString().split("T")[0]; // YYYY-MM-DD
      }

      function checkAndResetDailyQuota() {
        const today = getTodayDateString();
        if (gameState.dailyActionsDate !== today) {
          // New day - reset the counter!
          gameState.dailyActions = 0;
          gameState.dailyActionsDate = today;
          saveGame();
        }
      }

      function canPerformAction() {
        checkAndResetDailyQuota();
        return gameState.dailyActions < DAILY_ACTION_LIMIT;
      }

      function consumeDailyAction() {
        checkAndResetDailyQuota();
        if (gameState.dailyActions < DAILY_ACTION_LIMIT) {
          gameState.dailyActions++;
          saveGame();
          updateDailyActionsDisplay();
          return true;
        }
        return false;
      }

      function getRemainingDailyActions() {
        checkAndResetDailyQuota();
        return DAILY_ACTION_LIMIT - gameState.dailyActions;
      }

      function updateDailyActionsDisplay() {
        const remaining = getRemainingDailyActions();
        const display = document.getElementById("daily-actions-display");
        const displayBottom = document.getElementById(
          "daily-actions-display-bottom"
        );
        const amount = document.getElementById("daily-actions-remaining");
        const amountBottom = document.getElementById(
          "daily-actions-remaining-bottom"
        );

        if (amount) amount.textContent = remaining;
        if (amountBottom) amountBottom.textContent = remaining;

        // Update top tracker
        if (display) {
          display.classList.remove("low", "empty");
          if (remaining === 0) {
            display.classList.add("empty");
          } else if (remaining <= 3) {
            display.classList.add("low");
          }
        }

        // Update bottom tracker
        if (displayBottom) {
          displayBottom.classList.remove("low", "empty");
          if (remaining === 0) {
            displayBottom.classList.add("empty");
          } else if (remaining <= 3) {
            displayBottom.classList.add("low");
          }
        }
      }

      // Secret reset for testing - tap Overall Health 5 times
      let secretTapCount = 0;
      let secretTapTimer = null;

      function secretResetTap() {
        secretTapCount++;

        // Reset counter after 3 seconds of no taps
        if (secretTapTimer) clearTimeout(secretTapTimer);
        secretTapTimer = setTimeout(() => {
          secretTapCount = 0;
        }, 3000);

        if (secretTapCount >= 5) {
          // Secret code activated!
          gameState.dailyActions = 0;
          saveGame();
          updateDailyActionsDisplay();
          secretTapCount = 0;
          showPopup(
            "üîì Secret Reset!<br>Daily actions have been reset for testing! üß™"
          );
        }
      }

      // ============= INITIALIZATION =============
      function init() {
        loadGame();
        checkAndResetDailyQuota();
        if (gameState.chicken) {
          updateGame();
          updateMoneyDisplay();
          updateDailyActionsDisplay();
          showScreen("game-screen");
        }
        // Update game every minute
        setInterval(updateGame, 60000);
        // Check for day change every minute
        setInterval(() => {
          checkAndResetDailyQuota();
          updateDailyActionsDisplay();
        }, 60000);
      }

      // ============= SCREEN MANAGEMENT =============
      function showScreen(screenId) {
        document
          .querySelectorAll(".screen")
          .forEach((s) => s.classList.remove("active"));
        document.getElementById(screenId).classList.add("active");
      }

      function showTab(tabName) {
        // Cleanup QR scanner when leaving friends tab
        if (tabName !== "friends") {
          cleanupScanner();
        }

        document
          .querySelectorAll(".tab-content")
          .forEach((t) => t.classList.add("hidden"));
        document
          .querySelectorAll(".nav-item")
          .forEach((n) => n.classList.remove("active"));
        document.getElementById(tabName + "-tab").classList.remove("hidden");
        document.getElementById("nav-" + tabName).classList.add("active");

        if (tabName === "share") {
          generateQRCode();
        }
        if (tabName === "shop") {
          renderShop();
        }
        if (tabName === "friends") {
          renderFriends();
        }
      }

      // ============= CHICKEN CREATION =============
      function selectBreed(element) {
        document
          .querySelectorAll(".breed-option")
          .forEach((b) => b.classList.remove("selected"));
        element.classList.add("selected");
        selectedBreed = element.dataset.breed;
      }

      function createChicken() {
        const ownerName = document.getElementById("owner-name").value.trim();
        const chickenName = document
          .getElementById("chicken-name")
          .value.trim();

        if (!ownerName) {
          showPopup("üôà Please enter your name!");
          return;
        }
        if (!chickenName) {
          showPopup("üêî Please name your chicken!");
          return;
        }
        if (!selectedBreed) {
          showPopup("üê£ Please select a breed!");
          return;
        }

        gameState.chicken = {
          id: generateId(),
          name: chickenName,
          owner: ownerName,
          breed: selectedBreed,
          birthDate: Date.now(),
          virtualDays: 0, // Virtual age in days (increases with actions)
          needs: {
            hunger: 100,
            thirst: 100,
            cleanliness: 100,
            sleep: 100,
            happiness: 100,
            exercise: 100,
          },
          totalEggs: 0,
          isSick: false,
        };

        gameState.lastUpdate = Date.now();
        saveGame();
        updateGame();
        showScreen("game-screen");
        showPopup(
          `üéâ Welcome ${chickenName}! üê£<br>Your egg is about to hatch!`
        );
      }

      // ============= GAME LOGIC =============
      function updateGame() {
        if (!gameState.chicken) return;

        const now = Date.now();
        const timePassed = now - gameState.lastUpdate;
        const minutesPassed = timePassed / 60000;

        // Update needs (decrease over time) - with item effects
        const decay = minutesPassed * 0.5; // Needs decrease by 0.5 per minute

        // Check for item effects that reduce decay
        let hungerDecay = decay;
        let thirstDecay = decay * 1.2;
        let happinessDecay = decay * 0.2;
        let cleanlinessDecay = decay * 0.3;
        let sickChance = 0.1;

        // Apply item effects
        if (gameState.inventory.includes("vitamins")) {
          hungerDecay *= 0.7; // 30% slower hunger decay
        }
        if (gameState.inventory.includes("feather-polish")) {
          cleanlinessDecay *= 0.7; // 30% slower cleanliness decay
        }
        if (gameState.inventory.includes("robot-friend")) {
          happinessDecay *= 0.7; // 30% slower happiness decay
        }
        if (gameState.inventory.includes("mirror")) {
          happinessDecay *= 0.8; // 20% slower happiness decay
        }
        if (gameState.inventory.includes("deworm-tablets")) {
          sickChance *= 0.5; // 50% less chance of sickness
        }

        gameState.chicken.needs.hunger = Math.max(
          0,
          gameState.chicken.needs.hunger - hungerDecay
        );
        gameState.chicken.needs.thirst = Math.max(
          0,
          gameState.chicken.needs.thirst - thirstDecay
        );
        gameState.chicken.needs.cleanliness = Math.max(
          0,
          gameState.chicken.needs.cleanliness - cleanlinessDecay
        );
        gameState.chicken.needs.sleep = Math.max(
          0,
          gameState.chicken.needs.sleep - decay * 0.4
        );
        gameState.chicken.needs.happiness = Math.max(
          0,
          gameState.chicken.needs.happiness - happinessDecay
        );
        gameState.chicken.needs.exercise = Math.max(
          0,
          gameState.chicken.needs.exercise - decay * 0.3
        );

        // Check if chicken gets sick (if needs are too low)
        const avgNeeds =
          Object.values(gameState.chicken.needs).reduce((a, b) => a + b, 0) / 6;
        if (avgNeeds < 30 && Math.random() < sickChance) {
          gameState.chicken.isSick = true;
        }

        gameState.lastUpdate = now;
        saveGame();
        renderChicken();
      }

      function doAction(action) {
        if (!gameState.chicken) return;

        // Check daily quota
        if (!canPerformAction()) {
          showPopup(
            "‚è∞ You've used all 10 actions for today!<br>Come back tomorrow to play more! üåÖ"
          );
          return;
        }

        // Consume a daily action
        consumeDailyAction();

        // Each action = 5 days pass
        const daysAdded = 5;
        const oldAge = gameState.chicken.virtualDays || 0;
        gameState.chicken.virtualDays = oldAge + daysAdded;
        const newAge = gameState.chicken.virtualDays;

        // Check for milestone reached
        let milestoneReached = null;
        for (const milestone of MILESTONES) {
          if (oldAge < milestone.day && newAge >= milestone.day) {
            milestoneReached = milestone;
          }
        }

        // Store old needs to check if health improved
        const oldNeeds = { ...gameState.chicken.needs };
        const oldOverallHealth =
          Object.values(oldNeeds).reduce((a, b) => a + b, 0) / 6;

        let message = "";
        let improvedNeeds = []; // Track which needs improved

        switch (action) {
          case "feed":
            if (gameState.chicken.needs.hunger < 100) {
              gameState.chicken.needs.hunger = Math.min(
                100,
                gameState.chicken.needs.hunger + 40
              );
              improvedNeeds.push("hunger");
            }
            message = "üåæ Yummy! *peck peck peck*";
            break;
          case "water":
            if (gameState.chicken.needs.thirst < 100) {
              gameState.chicken.needs.thirst = Math.min(
                100,
                gameState.chicken.needs.thirst + 50
              );
              improvedNeeds.push("thirst");
            }
            message = "üíß *gulp gulp* Refreshing!";
            break;
          case "dustbath":
            if (gameState.chicken.needs.cleanliness < 100) {
              gameState.chicken.needs.cleanliness = Math.min(
                100,
                gameState.chicken.needs.cleanliness + 60
              );
              improvedNeeds.push("cleanliness");
            }
            if (gameState.chicken.needs.happiness < 100) {
              gameState.chicken.needs.happiness = Math.min(
                100,
                gameState.chicken.needs.happiness + 10
              );
              improvedNeeds.push("happiness");
            }
            message = "üõÅ *fluff fluff* So fluffy!";
            break;
          case "play":
            if (gameState.chicken.needs.happiness < 100) {
              gameState.chicken.needs.happiness = Math.min(
                100,
                gameState.chicken.needs.happiness + 30
              );
              improvedNeeds.push("happiness");
            }
            if (gameState.chicken.needs.exercise < 100) {
              gameState.chicken.needs.exercise = Math.min(
                100,
                gameState.chicken.needs.exercise + 20
              );
              improvedNeeds.push("exercise");
            }
            message = "üéæ *bawk bawk* So fun!";
            break;
          case "sleep":
            if (gameState.chicken.needs.sleep < 100) {
              gameState.chicken.needs.sleep = Math.min(
                100,
                gameState.chicken.needs.sleep + 50
              );
              improvedNeeds.push("sleep");
            }
            if (gameState.chicken.isSick && Math.random() < 0.3) {
              gameState.chicken.isSick = false;
              message = "üò¥ Zzz... Feeling better!";
            } else {
              message = "üò¥ Zzz... Good night!";
            }
            break;
          case "flap":
            if (gameState.chicken.needs.exercise < 100) {
              gameState.chicken.needs.exercise = Math.min(
                100,
                gameState.chicken.needs.exercise + 40
              );
              improvedNeeds.push("exercise");
            }
            if (gameState.chicken.needs.happiness < 100) {
              gameState.chicken.needs.happiness = Math.min(
                100,
                gameState.chicken.needs.happiness + 15
              );
              improvedNeeds.push("happiness");
            }
            message = "ü™Ω *flap flap flap* Wheee!";
            break;
        }

        // Helper function to get color status
        function getColorStatus(value) {
          if (value >= 60) return "green";
          if (value >= 40) return "yellow";
          return "red";
        }

        // Check if any need changed color status (red->yellow or yellow->green)
        let colorUpgradeHappened = false;
        const needKeys = [
          "hunger",
          "thirst",
          "cleanliness",
          "sleep",
          "happiness",
          "exercise",
        ];

        for (const key of needKeys) {
          const oldColor = getColorStatus(oldNeeds[key]);
          const newColor = getColorStatus(gameState.chicken.needs[key]);

          // Check for color upgrade: red->yellow or yellow->green
          if (
            (oldColor === "red" && newColor === "yellow") ||
            (oldColor === "red" && newColor === "green") ||
            (oldColor === "yellow" && newColor === "green")
          ) {
            colorUpgradeHappened = true;
            break;
          }
        }

        // Only earn money if a color status improved (red->yellow or yellow->green)
        if (colorUpgradeHappened) {
          gameState.money += 1;
          message += '<br><span class="coin-earn">+$1 üí∞</span>';
          message +=
            '<br><span style="color: #2e7d32; font-size: 0.85em;">üìà My health improves! Thanks for caring for me! üíï</span>';

          // Flag to show up arrow in Overall Health box
          gameState.showOverallHealthUpgrade = true;
        } else {
          message +=
            '<br><span style="color: #888; font-size: 0.85em;">Keep caring to improve my health status! üêî</span>';
          gameState.showOverallHealthUpgrade = false;
        }

        // Show remaining daily actions
        const remaining = getRemainingDailyActions();
        message += `<br><span style="color: #4169e1; font-size: 0.85em;">‚ö° ${remaining}/10 actions left today</span>`;

        // Show time passing message
        if (daysAdded > 0) {
          message += `<br><span style="color: #888; font-size: 0.9em;">‚è∞ ${daysAdded} days passed...</span>`;
        }

        // Show milestone notification
        if (milestoneReached) {
          message += `<br><br>üéâ <strong>Milestone!</strong><br>${milestoneReached.name}`;
        }

        updateMoneyDisplay();

        saveGame();
        renderChicken();
        showPopup(message);
      }

      // ============= RENDERING =============
      function renderChicken() {
        if (!gameState.chicken) return;

        const chicken = gameState.chicken;
        // Use virtualDays for age (accelerated time), fallback to real days for old saves
        const realDays = Math.floor(
          (Date.now() - chicken.birthDate) / (1000 * 60 * 60 * 24)
        );
        const ageInDays =
          chicken.virtualDays !== undefined ? chicken.virtualDays : realDays;

        // Get current stage
        let currentStage = MILESTONES[0];
        for (const milestone of MILESTONES) {
          if (ageInDays >= milestone.day) {
            currentStage = milestone;
          }
        }

        // Update display
        document.getElementById("display-name").textContent = chicken.name;
        document.getElementById("display-breed").textContent =
          BREEDS[chicken.breed].name;
        document.getElementById(
          "display-owner"
        ).textContent = `Owner: ${chicken.owner}`;
        document.getElementById("life-stage").textContent = currentStage.name;
        document.getElementById("chicken-age").textContent = ageInDays;

        // Progress bar
        const nextMilestone =
          MILESTONES.find((m) => m.day > ageInDays) ||
          MILESTONES[MILESTONES.length - 1];
        const prevMilestone =
          [...MILESTONES].reverse().find((m) => m.day <= ageInDays) ||
          MILESTONES[0];
        const progress =
          ((ageInDays - prevMilestone.day) /
            (nextMilestone.day - prevMilestone.day)) *
          100;
        const totalProgress =
          ((MILESTONES.findIndex((m) => m.day === currentStage.day) + 1) /
            MILESTONES.length) *
          100;
        document.getElementById("lifecycle-progress").style.width =
          Math.min(100, totalProgress) + "%";

        // Emoji chicken graphics
        const artStage = chicken.isSick ? "sick" : currentStage.stage;
        const graphics =
          CHICKEN_GRAPHICS[artStage] || CHICKEN_GRAPHICS["chick"];
        const chickenArt = document.getElementById("chicken-art");
        const stageLabel = document.getElementById("chicken-stage-label");
        const groundDecor = document.querySelector(".ground-decoration");
        const moodEl = document.getElementById("chicken-mood");
        const accessoriesEl = document.getElementById("chicken-accessories");

        // Set the chicken emoji
        chickenArt.textContent = graphics.emoji;
        chickenArt.style.fontSize = graphics.size || "80px";
        stageLabel.textContent = graphics.label;

        // Set ground decoration
        if (groundDecor) {
          groundDecor.textContent = graphics.ground || "üåøüåæüåø";
        }

        // Set animation class based on state
        chickenArt.className = "chicken-art";
        if (chicken.isSick) {
          chickenArt.classList.add("sick");
        } else if (chicken.needs.sleep < 30) {
          chickenArt.classList.add("sleeping");
        } else if (chicken.needs.happiness > 70) {
          chickenArt.classList.add("happy");
        }

        // Show mood indicator
        const mainStatus = getMainStatus(chicken);
        const moodEmojis = MOOD_EMOJIS[mainStatus] || MOOD_EMOJIS.happy;
        moodEl.textContent =
          moodEmojis[Math.floor(Math.random() * moodEmojis.length)];

        // Show accessories from inventory (decorations from shop)
        let accessories = [];
        if (graphics.accessory) accessories.push(graphics.accessory);

        // Add all decoration items from inventory
        Object.values(SHOP_ITEMS).forEach((item) => {
          if (
            item.category === "decorations" &&
            gameState.inventory.includes(item.id)
          ) {
            accessories.push(item.displayIcon);
          }
        });

        // Legacy items support
        if (gameState.inventory.includes("fake-eggs")) accessories.push("ü•ö");
        if (gameState.inventory.includes("cup-water-set"))
          accessories.push("ü•§");

        // Display up to 8 accessories (decorations shown above chicken)
        accessoriesEl.textContent = accessories.slice(0, 8).join(" ");

        // Status bar
        renderStatus();

        // Milestones
        renderMilestones(ageInDays);
      }

      function getMainStatus(chicken) {
        if (chicken.isSick) return "sick";
        if (chicken.needs.hunger < 40) return "hungry";
        if (chicken.needs.thirst < 40) return "thirsty";
        if (chicken.needs.sleep < 40) return "sleepy";
        if (chicken.needs.cleanliness < 40) return "dusty";
        if (chicken.needs.exercise < 40) return "wantFlap";
        if (chicken.needs.happiness < 40) return "bored";
        return "happy";
      }

      function renderStatus() {
        const chicken = gameState.chicken;
        const statusBar = document.getElementById("status-bar");
        const activeStatuses = [];

        if (chicken.isSick) {
          activeStatuses.push({ ...STATUSES.sick, key: "sick" });
        }
        if (chicken.needs.hunger < 40) {
          activeStatuses.push({ ...STATUSES.hungry, key: "hungry" });
        }
        if (chicken.needs.thirst < 40) {
          activeStatuses.push({ ...STATUSES.thirsty, key: "thirsty" });
        }
        if (chicken.needs.cleanliness < 40) {
          activeStatuses.push({ ...STATUSES.dusty, key: "dusty" });
        }
        if (chicken.needs.sleep < 40) {
          activeStatuses.push({ ...STATUSES.sleepy, key: "sleepy" });
        }
        if (chicken.needs.exercise < 40) {
          activeStatuses.push({ ...STATUSES.wantFlap, key: "wantFlap" });
        }
        if (chicken.needs.happiness < 40) {
          activeStatuses.push({ ...STATUSES.bored, key: "bored" });
        }

        if (activeStatuses.length === 0) {
          activeStatuses.push({ ...STATUSES.happy, key: "happy" });
        }

        statusBar.innerHTML = activeStatuses
          .map((s) => {
            let className = "status-item";
            if (s.priority >= 3) className += " critical";
            else if (s.priority >= 2) className += " warning";
            return `<span class="${className}">${s.icon} ${s.text}</span>`;
          })
          .join("");

        // Update health indicator bars
        renderHealthIndicators();
      }

      function renderHealthIndicators() {
        const chicken = gameState.chicken;
        if (!chicken) return;

        const needs = [
          { key: "hunger", value: chicken.needs.hunger },
          { key: "thirst", value: chicken.needs.thirst },
          { key: "cleanliness", value: chicken.needs.cleanliness },
          { key: "sleep", value: chicken.needs.sleep },
          { key: "happiness", value: chicken.needs.happiness },
          { key: "exercise", value: chicken.needs.exercise },
        ];

        // Calculate overall health (average of all needs)
        const overallHealth = Math.round(
          needs.reduce((sum, need) => sum + need.value, 0) / needs.length
        );

        // Update overall health display
        const overallEl = document.getElementById("overall-health");
        const overallValue = document.getElementById("overall-health-value");
        if (overallValue) {
          // Check if we should show the up arrow (color status improved)
          if (gameState.showOverallHealthUpgrade) {
            overallValue.innerHTML = `${overallHealth}% <span class="health-up-arrow">‚¨ÜÔ∏è</span>`;
            // Clear the arrow after 2.5 seconds
            setTimeout(() => {
              if (overallValue) overallValue.textContent = `${overallHealth}%`;
              gameState.showOverallHealthUpgrade = false;
            }, 2500);
          } else {
            overallValue.textContent = `${overallHealth}%`;
          }

          overallValue.classList.remove("high", "medium", "low");
          if (overallHealth >= 60) {
            overallValue.classList.add("high");
          } else if (overallHealth >= 40) {
            overallValue.classList.add("medium");
          } else {
            overallValue.classList.add("low");
          }
        }
        if (overallEl) {
          overallEl.classList.remove("warning", "critical");
          if (overallHealth < 40) {
            overallEl.classList.add("critical");
          } else if (overallHealth < 60) {
            overallEl.classList.add("warning");
          }
        }

        needs.forEach((need) => {
          const bar = document.getElementById(`${need.key}-bar`);
          const percent = document.getElementById(`${need.key}-percent`);
          const value = Math.round(need.value);

          if (bar) {
            bar.style.width = `${value}%`;
            bar.classList.remove("high", "medium", "low");
            if (value >= 60) {
              bar.classList.add("high");
            } else if (value >= 40) {
              bar.classList.add("medium");
            } else {
              bar.classList.add("low");
            }
          }

          if (percent) {
            percent.textContent = `${value}%`;
          }
        });
      }

      function renderMilestones(currentAge) {
        const list = document.getElementById("milestone-list");
        list.innerHTML = MILESTONES.map((m) => {
          let className = "milestone";
          let icon = "‚¨ú";
          if (currentAge >= m.day) {
            className += " achieved";
            icon = "‚úÖ";
          }
          const currentMilestone = MILESTONES.filter(
            (x) => currentAge >= x.day
          ).pop();
          if (currentMilestone && m.day === currentMilestone.day) {
            className += " current";
          }
          return `<div class="${className}">${icon} ${m.name} (Day ${m.day})</div>`;
        }).join("");
      }

      // ============= QR CODE & SHARING =============
      function generateQRCode() {
        const code = encodeChickenData();
        document.getElementById("chicken-code").value = code;

        // Generate simple visual QR-like pattern
        const qrDiv = document.getElementById("qrcode");
        qrDiv.innerHTML = generateVisualCode(code);
      }

      function encodeChickenData() {
        const c = gameState.chicken;
        // Use virtualDays for age
        const realDays = Math.floor(
          (Date.now() - c.birthDate) / (1000 * 60 * 60 * 24)
        );
        const ageInDays =
          c.virtualDays !== undefined ? c.virtualDays : realDays;

        // Get current stage
        let stage = "egg";
        for (const milestone of MILESTONES) {
          if (ageInDays >= milestone.day) {
            stage = milestone.stage;
          }
        }

        const data = {
          n: c.name,
          o: c.owner,
          b: c.breed,
          a: ageInDays,
          s: stage,
          h: Math.round(
            (c.needs.hunger +
              c.needs.thirst +
              c.needs.cleanliness +
              c.needs.sleep +
              c.needs.happiness +
              c.needs.exercise) /
              6
          ),
          i: c.id,
        };

        // Use simple prefix for QR compatibility
        // Make the data shorter by using minimal JSON and URL-safe base64
        const jsonStr = JSON.stringify(data);
        const base64 = btoa(jsonStr)
          .replace(/\+/g, "-")
          .replace(/\//g, "_")
          .replace(/=/g, "");
        return "CHKN" + base64;
      }

      function generateVisualCode(code) {
        // Use qrcode-generator library (embedded for offline use)
        // Calculate appropriate type number based on data length
        // Type 4 with L error correction can hold up to 78 characters
        let typeNumber = 4;
        if (code.length > 78) typeNumber = 6;
        if (code.length > 134) typeNumber = 8;
        if (code.length > 192) typeNumber = 10;

        let qr;
        try {
          qr = qrcode(typeNumber, "L");
          qr.addData(code);
          qr.make();
        } catch (e) {
          // If it fails, try a larger type
          try {
            qr = qrcode(typeNumber + 2, "L");
            qr.addData(code);
            qr.make();
          } catch (e2) {
            console.error("QR code generation failed:", e2);
            return '<div style="padding: 20px; color: #666;">QR code unavailable</div>';
          }
        }

        const size = qr.getModuleCount();
        const pixelSize = Math.max(5, Math.floor(180 / size));

        // Color theme
        const codeSum = code
          .split("")
          .reduce((sum, c) => sum + c.charCodeAt(0), 0);
        const colors = [
          { dark: "#000000", light: "#FFF0F5", border: "#FF69B4" },
          { dark: "#000000", light: "#F8F0FF", border: "#9932CC" },
          { dark: "#000000", light: "#FFF5F5", border: "#FF6347" },
          { dark: "#000000", light: "#F0FFF0", border: "#32CD32" },
          { dark: "#000000", light: "#F0F8FF", border: "#4169E1" },
        ];
        const theme = colors[codeSum % colors.length];

        let html = `<div style="display: inline-block; padding: 15px; background: ${theme.light}; border-radius: 15px; border: 3px solid ${theme.border};">`;
        html += `<div style="text-align: center; margin-bottom: 8px;"><span style="font-size: 1.8em;">üêî</span></div>`;
        html += `<div style="display: inline-block; padding: 10px; background: white; border-radius: 8px;">`;
        html += `<div style="display: grid; grid-template-columns: repeat(${size}, ${pixelSize}px); gap: 0;">`;

        for (let row = 0; row < size; row++) {
          for (let col = 0; col < size; col++) {
            const color = qr.isDark(row, col) ? theme.dark : "white";
            html += `<div style="width:${pixelSize}px;height:${pixelSize}px;background:${color};"></div>`;
          }
        }

        html += "</div></div>";
        const sparkles = ["‚ú®", "üíï", "‚≠ê", "üå∏", "üí´"];
        html += `<div style="text-align:center;margin-top:8px;font-size:0.95em;color:${
          theme.border
        };font-weight:500;">${sparkles[codeSum % 5]} Scan Me! ${
          sparkles[(codeSum + 2) % 5]
        }</div>`;
        html += "</div>";

        return html;
      }

      function copyChickenCode() {
        const code = document.getElementById("chicken-code").value;
        navigator.clipboard
          .writeText(code)
          .then(() => {
            showPopup("üìã Code copied! Share it with friends!");
          })
          .catch(() => {
            showPopup("üìã Select the code and copy manually!");
          });
      }

      // ============= FRIENDS =============
      function addFriend() {
        const input = document.getElementById("friend-code-input").value.trim();

        if (!input) {
          showPopup("üôà Please paste a chicken code!");
          return;
        }

        // Ensure friends array exists
        if (!Array.isArray(gameState.friends)) {
          gameState.friends = [];
        }

        try {
          // Support old format (üêî...üêî), middle format (CHKN:...), and new format (CHKN...)
          let base64Data;
          const emojiMatch = input.match(/üêî(.+)üêî/);
          const colonMatch = input.match(/CHKN:(.+)/);
          const newMatch = input.match(/^CHKN([A-Za-z0-9_-]+)$/);

          if (emojiMatch) {
            base64Data = emojiMatch[1];
          } else if (colonMatch) {
            base64Data = colonMatch[1];
          } else if (newMatch) {
            // Convert URL-safe base64 back to standard
            base64Data = newMatch[1].replace(/-/g, "+").replace(/_/g, "/");
            // Add padding if needed
            while (base64Data.length % 4) base64Data += "=";
          } else {
            throw new Error("Invalid format");
          }

          const data = JSON.parse(atob(base64Data));

          // Check if already a friend
          if (gameState.friends.some((f) => f.i === data.i)) {
            showPopup("üêî This chicken is already your friend!");
            renderFriends(); // Re-render to ensure list is displayed
            return;
          }

          // Check if it's your own chicken
          if (data.i === gameState.chicken.id) {
            showPopup("ü§≠ That's your own chicken, silly!");
            return;
          }

          gameState.friends.push(data);
          saveGame();
          renderFriends();
          document.getElementById("friend-code-input").value = "";
          showPopup(`üéâ ${data.n} is now your friend!`);
        } catch (e) {
          console.error("Error adding friend:", e);
          showPopup("üòï Invalid chicken code. Try again!");
        }
      }

      function renderFriends() {
        const list = document.getElementById("friends-list");

        if (gameState.friends.length === 0) {
          list.innerHTML = `
                    <p style="text-align: center; color: #888; margin: 20px 0;">
                        No friends yet! üê£<br>
                        Scan a friend's code to add them!
                    </p>
                `;
          return;
        }

        list.innerHTML = gameState.friends
          .map((f) => {
            const breedInfo = BREEDS[f.b] || { name: "Unknown" };
            const currentMilestone =
              MILESTONES.filter((m) => f.a >= m.day).pop() || MILESTONES[0];
            const healthEmoji = f.h >= 70 ? "üíö" : f.h >= 40 ? "üíõ" : "‚ù§Ô∏è";

            return `
                    <div class="friend-card">
                        <div class="name">üêî ${f.n}</div>
                        <div>Owner: ${f.o}</div>
                        <div>Breed: ${breedInfo.name}</div>
                        <div>Stage: ${currentMilestone.name}</div>
                        <div>Health: ${healthEmoji} ${f.h}%</div>
                    </div>
                `;
          })
          .join("");
      }

      // ============= QR CODE SCANNER =============
      let scannerStream = null;
      let scannerAnimationId = null;
      let isScanning = false;

      function toggleQRScanner() {
        // Check if jsQR library is available
        if (typeof jsQR === "undefined") {
          showPopup(
            "üì∑ Camera scanning requires internet connection.\n\nPlease paste the code manually instead!"
          );
          return;
        }

        if (isScanning) {
          stopQRScanner();
        } else {
          startQRScanner();
        }
      }

      async function startQRScanner() {
        const video = document.getElementById("scanner-video");
        const canvas = document.getElementById("scanner-canvas");
        const container = document.getElementById("scanner-container");
        const statusEl = document.getElementById("scanner-status");
        const scanBtn = document.getElementById("scan-btn");

        try {
          // Request camera permission
          statusEl.textContent = "üì∑ Requesting camera access...";
          statusEl.className = "scanner-status";

          scannerStream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: "environment" }, // Prefer back camera
          });

          video.srcObject = scannerStream;
          video.setAttribute("playsinline", true);
          await video.play();

          container.style.display = "block";
          scanBtn.textContent = "‚èπÔ∏è Stop Scanning";
          scanBtn.className = "btn red";
          statusEl.textContent = "üîç Point camera at QR code...";
          statusEl.className = "scanner-status scanning";
          isScanning = true;

          // Start scanning loop
          const ctx = canvas.getContext("2d");
          scanFrame(video, canvas, ctx, statusEl);
        } catch (err) {
          console.error("Camera error:", err);
          statusEl.textContent =
            "‚ùå Could not access camera. Please allow camera permission.";
          statusEl.className = "scanner-status error";
          container.style.display = "none";
        }
      }

      function scanFrame(video, canvas, ctx, statusEl) {
        if (!isScanning) return;

        if (video.readyState === video.HAVE_ENOUGH_DATA) {
          canvas.height = video.videoHeight;
          canvas.width = video.videoWidth;
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

          // Use jsQR to detect QR code
          const code = jsQR(imageData.data, imageData.width, imageData.height, {
            inversionAttempts: "dontInvert",
          });

          if (code) {
            // QR code detected!
            const scannedData = code.data;

            // Check if it's a valid chicken code
            if (scannedData.startsWith("CHKN") || scannedData.includes("üêî")) {
              statusEl.textContent = "‚úÖ QR Code detected! Adding friend...";
              statusEl.className = "scanner-status success";

              // Stop scanner and process the code
              stopQRScanner();
              processScannedCode(scannedData);
              return;
            }
          }
        }

        // Continue scanning
        scannerAnimationId = requestAnimationFrame(() =>
          scanFrame(video, canvas, ctx, statusEl)
        );
      }

      function stopQRScanner() {
        isScanning = false;

        if (scannerAnimationId) {
          cancelAnimationFrame(scannerAnimationId);
          scannerAnimationId = null;
        }

        if (scannerStream) {
          scannerStream.getTracks().forEach((track) => track.stop());
          scannerStream = null;
        }

        const video = document.getElementById("scanner-video");
        if (video) {
          video.srcObject = null;
        }

        const container = document.getElementById("scanner-container");
        const scanBtn = document.getElementById("scan-btn");
        const statusEl = document.getElementById("scanner-status");

        if (container) container.style.display = "none";
        if (scanBtn) {
          scanBtn.textContent = "üì∑ Start Camera Scan";
          scanBtn.className = "btn blue";
        }
        if (statusEl) {
          statusEl.textContent = "";
          statusEl.className = "scanner-status";
        }
      }

      function processScannedCode(scannedData) {
        // Ensure friends array exists
        if (!Array.isArray(gameState.friends)) {
          gameState.friends = [];
        }

        try {
          // Parse the scanned code (same logic as addFriend)
          let base64Data;
          const emojiMatch = scannedData.match(/üêî(.+)üêî/);
          const colonMatch = scannedData.match(/CHKN:(.+)/);
          const newMatch = scannedData.match(/^CHKN([A-Za-z0-9_-]+)$/);

          if (emojiMatch) {
            base64Data = emojiMatch[1];
          } else if (colonMatch) {
            base64Data = colonMatch[1];
          } else if (newMatch) {
            base64Data = newMatch[1].replace(/-/g, "+").replace(/_/g, "/");
            while (base64Data.length % 4) base64Data += "=";
          } else {
            throw new Error("Invalid format");
          }

          const data = JSON.parse(atob(base64Data));

          // Check if already a friend
          if (gameState.friends.some((f) => f.i === data.i)) {
            showPopup("üêî This chicken is already your friend!");
            renderFriends(); // Re-render to ensure list is displayed
            return;
          }

          // Check if it's your own chicken
          if (data.i === gameState.chicken.id) {
            showPopup("ü§≠ That's your own chicken, silly!");
            return;
          }

          // Add the friend
          gameState.friends.push(data);
          saveGame();
          renderFriends();
          showPopup(
            `üéâ ${data.n} is now your friend!\n\nScanned successfully via camera! üì∏`
          );
        } catch (e) {
          console.error("Failed to process scanned code:", e);
          showPopup("üòï Invalid QR code. Make sure it's a valid chicken code!");
        }
      }

      // Stop scanner when navigating away from friends tab
      function cleanupScanner() {
        if (isScanning) {
          stopQRScanner();
        }
      }

      // ============= UTILITIES =============
      function generateId() {
        return "ck_" + Math.random().toString(36).substr(2, 9);
      }

      function formatAge(days) {
        if (days === 0) return "Just born!";
        if (days === 1) return "1 day old";
        if (days < 7) return `${days} days old`;
        if (days < 30)
          return `${Math.floor(days / 7)} week${days >= 14 ? "s" : ""} old`;
        if (days < 365)
          return `${Math.floor(days / 30)} month${days >= 60 ? "s" : ""} old`;
        return `${Math.floor(days / 365)} year${days >= 730 ? "s" : ""} old`;
      }

      function showPopup(message) {
        document.getElementById("popup-content").innerHTML = message;
        document.getElementById("popup").classList.remove("hidden");
        document.getElementById("overlay").classList.remove("hidden");
      }

      function hidePopup() {
        document.getElementById("popup").classList.add("hidden");
        document.getElementById("overlay").classList.add("hidden");
      }

      function updateMoneyDisplay() {
        document.getElementById("money-amount").textContent = gameState.money;
      }

      // ============= SHOP SYSTEM =============
      let currentShopCategory = "decorations";

      function showShopCategory(category) {
        currentShopCategory = category;

        // Update category button states
        document.querySelectorAll(".category-btn").forEach((btn) => {
          btn.classList.remove("active");
        });
        document.getElementById("cat-" + category).classList.add("active");

        renderShop();
      }

      function renderShop() {
        const shopDiv = document.getElementById("shop-items");

        // Filter items by current category
        const categoryItems = Object.values(SHOP_ITEMS).filter(
          (item) => item.category === currentShopCategory
        );

        shopDiv.innerHTML = categoryItems
          .map((item) => {
            const owned = gameState.inventory.includes(item.id);
            return `
                    <div class="shop-item ${item.category} ${
              owned ? "owned" : ""
            }">
                        <div class="item-icon">${item.icon}</div>
                        <div class="item-info">
                            <div class="item-name">${item.name}</div>
                            <div class="item-desc">${item.description}</div>
                        </div>
                        ${
                          owned
                            ? '<span class="owned-badge">‚úì Owned</span>'
                            : `<button class="btn small" onclick="buyItem('${item.id}')">$${item.price}</button>`
                        }
                    </div>
                `;
          })
          .join("");

        renderInventory();
      }

      function renderInventory() {
        const invDiv = document.getElementById("inventory");

        // Filter out any old items that no longer exist in shop
        const validItems = gameState.inventory.filter(
          (itemId) => SHOP_ITEMS[itemId]
        );

        if (validItems.length === 0) {
          invDiv.innerHTML =
            '<p style="text-align: center; color: #888; width: 100%;">No items yet! üõí</p>';
          return;
        }

        invDiv.innerHTML = validItems
          .map((itemId) => {
            const item = SHOP_ITEMS[itemId];
            return `
                    <div class="inventory-item" title="${item.name}">
                        <div class="item-emoji">${
                          item.displayIcon || item.icon
                        }</div>
                        <div style="font-size: 0.7em; text-align: center;">${
                          item.name.split(" ")[0]
                        }</div>
                    </div>
                `;
          })
          .join("");
      }

      function buyItem(itemId) {
        const item = SHOP_ITEMS[itemId];

        if (!item) {
          showPopup("üôà Item not found!");
          return;
        }

        // Check daily quota
        if (!canPerformAction()) {
          showPopup(
            "‚è∞ You've used all 10 actions for today!<br>Come back tomorrow to shop more! üåÖ"
          );
          return;
        }

        if (gameState.inventory.includes(itemId)) {
          showPopup("üõí You already have this item!");
          return;
        }

        if (gameState.money < item.price) {
          showPopup(
            "üí∏ Not enough money!<br>Take care of your chicken to earn more!"
          );
          return;
        }

        // Consume a daily action for the purchase
        consumeDailyAction();

        gameState.money -= item.price;
        gameState.inventory.push(itemId);

        // Apply immediate happiness boost if item has happiness effect
        if (item.effect && item.effect.happiness && gameState.chicken) {
          gameState.chicken.needs.happiness = Math.min(
            100,
            gameState.chicken.needs.happiness + item.effect.happiness
          );
        }

        updateMoneyDisplay();
        saveGame();
        renderShop();
        showPopup(
          `üéâ You bought ${item.name}!<br>${item.icon} ${item.description}`
        );
      }

      // ============= SAVE/LOAD =============
      function saveGame() {
        try {
          localStorage.setItem("chickenGame", JSON.stringify(gameState));
        } catch (e) {
          console.error("Failed to save game:", e);
          // Storage might be full or in private mode
        }
      }

      function loadGame() {
        try {
          const saved = localStorage.getItem("chickenGame");
          if (saved) {
            const loaded = JSON.parse(saved);
            gameState = {
              ...gameState,
              ...loaded,
              // Ensure arrays and values exist for old saves
              money: loaded.money !== undefined ? loaded.money : 5,
              inventory: Array.isArray(loaded.inventory)
                ? loaded.inventory
                : [],
              friends: Array.isArray(loaded.friends) ? loaded.friends : [],
              actionCount: loaded.actionCount || 0,
            };
            // Ensure virtualDays exists for old saves - calculate from real time
            if (
              gameState.chicken &&
              gameState.chicken.virtualDays === undefined
            ) {
              const realDays = Math.floor(
                (Date.now() - gameState.chicken.birthDate) /
                  (1000 * 60 * 60 * 24)
              );
              gameState.chicken.virtualDays = realDays;
            }
          }
        } catch (e) {
          console.error("Failed to load game:", e);
          // Reset to safe defaults on error
          gameState.friends = [];
          gameState.inventory = [];
        }
      }

      function loadExistingChicken() {
        loadGame();
        if (gameState.chicken) {
          updateGame();
          updateMoneyDisplay();
          showScreen("game-screen");
          renderFriends();
        } else {
          showPopup("üê£ No saved chicken found!<br>Create a new one!");
        }
      }

      // Request persistent storage to prevent eviction on iOS Safari
      async function requestPersistentStorage() {
        if (navigator.storage && navigator.storage.persist) {
          try {
            const isPersisted = await navigator.storage.persist();
            console.log(
              `Persistent storage ${isPersisted ? "granted" : "not granted"}`
            );
          } catch (e) {
            console.log("Persistent storage not available");
          }
        }
      }

      // Register service worker for PWA (helps with storage persistence)
      if ("serviceWorker" in navigator) {
        // Create a minimal service worker inline
        const swCode = `
          self.addEventListener('install', e => self.skipWaiting());
          self.addEventListener('activate', e => e.waitUntil(clients.claim()));
          self.addEventListener('fetch', e => e.respondWith(fetch(e.request).catch(() => caches.match(e.request))));
        `;
        const swBlob = new Blob([swCode], { type: "application/javascript" });
        const swUrl = URL.createObjectURL(swBlob);
        navigator.serviceWorker.register(swUrl).catch(() => {});
      }

      // Request persistent storage on load
      requestPersistentStorage();

      // Start the game!
      init();
    </script>
  </body>
</html>
