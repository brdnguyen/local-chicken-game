<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>üêî My Virtual Chicken üêî</title>
    <!-- QR Code library for scannable codes -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        -webkit-text-size-adjust: 100%;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background: linear-gradient(
          135deg,
          #87ceeb 0%,
          #98fb98 50%,
          #f0e68c 100%
        );
        min-height: 100vh;
        padding: 10px;
        font-size: 16px;
        line-height: 1.5;
        -webkit-font-smoothing: antialiased;
      }

      .container {
        max-width: 500px;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        padding: 20px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        border: 4px solid #ffb6c1;
      }

      h1 {
        text-align: center;
        color: #ff69b4;
        font-size: 1.6em;
        font-weight: 700;
        margin-bottom: 15px;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
      }

      h2 {
        color: #ff69b4;
        font-size: 1.15em;
        font-weight: 600;
        margin: 15px 0 10px 0;
        border-bottom: 2px dashed #ffb6c1;
        padding-bottom: 5px;
      }

      .screen {
        display: none;
      }

      .screen.active {
        display: block;
      }

      .chicken-display {
        background: #fffacd;
        border: 3px solid #ffd700;
        border-radius: 15px;
        padding: 15px;
        margin: 10px 0;
        text-align: center;
      }

      .ascii-art {
        font-family: "Courier New", monospace;
        font-size: 12px;
        line-height: 1.2;
        white-space: pre;
        background: #fff8dc;
        padding: 10px;
        border-radius: 10px;
        display: inline-block;
        margin: 10px 0;
      }

      .status-bar {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        justify-content: center;
        margin: 10px 0;
      }

      .status-item {
        background: #ffe4e1;
        padding: 6px 12px;
        border-radius: 15px;
        font-size: 0.9em;
        font-weight: 500;
        border: 2px solid #ffb6c1;
      }

      .status-item.warning {
        background: #ffeb3b;
        border-color: #ffc107;
        animation: pulse 1s infinite;
      }

      .status-item.critical {
        background: #ff8a80;
        border-color: #ff5252;
        animation: shake 0.5s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
      }

      @keyframes shake {
        0%,
        100% {
          transform: translateX(0);
        }
        25% {
          transform: translateX(-2px);
        }
        75% {
          transform: translateX(2px);
        }
      }

      .btn {
        background: linear-gradient(180deg, #ff69b4, #ff1493);
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 25px;
        font-size: 1em;
        font-weight: 600;
        font-family: inherit;
        cursor: pointer;
        margin: 5px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        transition: transform 0.2s, box-shadow 0.2s;
      }

      .btn:hover,
      .btn:active {
        transform: translateY(-2px);
        box-shadow: 0 6px 8px rgba(0, 0, 0, 0.3);
      }

      .btn.small {
        padding: 8px 15px;
        font-size: 0.9em;
      }

      .btn.green {
        background: linear-gradient(180deg, #90ee90, #32cd32);
      }

      .btn.blue {
        background: linear-gradient(180deg, #87ceeb, #4169e1);
      }

      .btn.orange {
        background: linear-gradient(180deg, #ffb347, #ff8c00);
      }

      input,
      select {
        width: 100%;
        padding: 12px;
        margin: 8px 0;
        border: 3px solid #ffb6c1;
        border-radius: 15px;
        font-size: 16px;
        font-family: inherit;
        -webkit-appearance: none;
        appearance: none;
      }

      input:focus,
      select:focus {
        outline: none;
        border-color: #ff69b4;
        box-shadow: 0 0 10px rgba(255, 105, 180, 0.3);
      }

      label {
        display: block;
        font-weight: 600;
        color: #555;
        margin-top: 10px;
      }

      .breed-selector {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: center;
        margin: 10px 0;
      }

      .breed-option {
        background: #fff0f5;
        border: 3px solid #ffb6c1;
        border-radius: 15px;
        padding: 10px;
        cursor: pointer;
        text-align: center;
        width: 95px;
        transition: all 0.2s;
        font-weight: 500;
        font-size: 0.9em;
      }

      .breed-option:hover,
      .breed-option.selected {
        border-color: #ff69b4;
        background: #ffe4e1;
        transform: scale(1.05);
      }

      .breed-option .breed-icon {
        font-size: 2em;
      }

      .action-buttons {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 8px;
        margin: 15px 0;
      }

      .info-box {
        background: #e8f5e9;
        border: 2px solid #81c784;
        border-radius: 10px;
        padding: 12px;
        margin: 10px 0;
        font-size: 0.95em;
        line-height: 1.6;
      }

      .lifecycle-bar {
        background: #e0e0e0;
        border-radius: 10px;
        height: 20px;
        margin: 10px 0;
        overflow: hidden;
      }

      .lifecycle-progress {
        background: linear-gradient(90deg, #ffd700, #ffa500, #ff69b4);
        height: 100%;
        transition: width 0.5s;
      }

      .qr-container {
        text-align: center;
        padding: 15px;
        background: white;
        border-radius: 15px;
        margin: 10px 0;
      }

      #qrcode {
        display: inline-block;
        padding: 10px;
        background: white;
      }

      .friend-card {
        background: #fff0f5;
        border: 2px solid #ffb6c1;
        border-radius: 15px;
        padding: 12px;
        margin: 10px 0;
      }

      .friend-card .name {
        font-weight: bold;
        color: #ff69b4;
        font-size: 1.1em;
      }

      .tabs {
        display: flex;
        justify-content: center;
        gap: 5px;
        margin-bottom: 15px;
      }

      .tab {
        padding: 10px 15px;
        background: #ffe4e1;
        border: 2px solid #ffb6c1;
        border-radius: 15px 15px 0 0;
        cursor: pointer;
        font-size: 0.9em;
      }

      .tab.active {
        background: #ff69b4;
        color: white;
        border-color: #ff69b4;
      }

      .milestone-list {
        text-align: left;
        padding: 10px;
      }

      .milestone {
        padding: 5px 0;
        border-bottom: 1px dashed #ffb6c1;
      }

      .milestone.achieved {
        color: #32cd32;
      }

      .milestone.current {
        font-weight: bold;
        color: #ff69b4;
      }

      .hidden {
        display: none !important;
      }

      .message-popup {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 20px;
        border-radius: 20px;
        border: 4px solid #ff69b4;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        z-index: 1000;
        text-align: center;
        max-width: 300px;
      }

      .overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
      }

      .nav-bar {
        display: flex;
        justify-content: space-around;
        background: #ffe4e1;
        border-radius: 15px;
        padding: 10px;
        margin-bottom: 15px;
      }

      .nav-item {
        text-align: center;
        cursor: pointer;
        padding: 8px 12px;
        border-radius: 10px;
        font-weight: 500;
      }

      .nav-item.active {
        background: #ff69b4;
        color: white;
      }

      .nav-item .icon {
        font-size: 1.4em;
        display: block;
        margin-bottom: 2px;
      }

      .scan-area {
        border: 3px dashed #ff69b4;
        border-radius: 15px;
        padding: 20px;
        margin: 10px 0;
        text-align: center;
      }

      textarea {
        width: 100%;
        padding: 12px;
        margin: 8px 0;
        border: 3px solid #ffb6c1;
        border-radius: 15px;
        font-size: 14px;
        font-family: ui-monospace, "SF Mono", Menlo, Monaco, monospace;
        resize: vertical;
        min-height: 80px;
        -webkit-appearance: none;
      }

      .money-display {
        background: linear-gradient(135deg, #ffd700 0%, #ffa500 100%);
        color: #333;
        padding: 8px 15px;
        border-radius: 20px;
        font-weight: 700;
        font-size: 1.1em;
        display: inline-block;
        margin: 10px 0;
        box-shadow: 0 3px 10px rgba(255, 165, 0, 0.3);
        border: 2px solid #ff8c00;
      }

      .shop-item {
        background: #fff9e6;
        border: 3px solid #ffd700;
        border-radius: 15px;
        padding: 12px;
        margin: 10px 0;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .shop-item.owned {
        background: #e8f5e9;
        border-color: #81c784;
      }

      .shop-item .item-icon {
        font-size: 2em;
        width: 50px;
        text-align: center;
      }

      .shop-item .item-info {
        flex: 1;
      }

      .shop-item .item-name {
        font-weight: 600;
        color: #333;
      }

      .shop-item .item-desc {
        font-size: 0.85em;
        color: #666;
      }

      .shop-item .item-price {
        font-weight: 700;
        color: #ff8c00;
      }

      .shop-item .owned-badge {
        background: #81c784;
        color: white;
        padding: 4px 10px;
        border-radius: 10px;
        font-size: 0.8em;
        font-weight: 600;
      }

      .inventory-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: center;
        margin: 10px 0;
      }

      .inventory-item {
        background: #fff0f5;
        border: 2px solid #ffb6c1;
        border-radius: 12px;
        padding: 10px;
        text-align: center;
        width: 70px;
      }

      .inventory-item .item-emoji {
        font-size: 1.8em;
      }

      .coin-earn {
        color: #ff8c00;
        font-weight: 600;
        animation: coinPop 0.5s ease-out;
      }

      @keyframes coinPop {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.3);
        }
        100% {
          transform: scale(1);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Welcome Screen -->
      <div id="welcome-screen" class="screen active">
        <h1>üêî My Virtual Chicken üêî</h1>
        <div class="ascii-art">\\ _ \\ / \ || ( @ > || \__/ // ||// ^^</div>
        <p style="text-align: center; margin: 15px 0; color: #666">
          Welcome to the cutest chicken game ever! üå∏<br />
          Raise your own virtual chicken!
        </p>
        <div style="text-align: center">
          <button class="btn" onclick="showScreen('create-screen')">
            üê£ New Chicken
          </button>
          <button class="btn green" onclick="loadExistingChicken()">
            üìÇ Continue
          </button>
        </div>
      </div>

      <!-- Create Chicken Screen -->
      <div id="create-screen" class="screen">
        <h1>üê£ Create Your Chicken üê£</h1>

        <label>Your Name (Owner):</label>
        <input
          type="text"
          id="owner-name"
          placeholder="Enter your name..."
          maxlength="20"
        />

        <label>Chicken's Name:</label>
        <input
          type="text"
          id="chicken-name"
          placeholder="Name your chicken..."
          maxlength="20"
        />

        <label>Choose a Breed:</label>
        <div class="breed-selector">
          <div
            class="breed-option"
            data-breed="isa-brown"
            onclick="selectBreed(this)"
          >
            <div class="breed-icon">üêî</div>
            <div>ISA Brown</div>
          </div>
          <div
            class="breed-option"
            data-breed="silkie"
            onclick="selectBreed(this)"
          >
            <div class="breed-icon">üê•</div>
            <div>Silkie</div>
          </div>
          <div
            class="breed-option"
            data-breed="leghorn"
            onclick="selectBreed(this)"
          >
            <div class="breed-icon">üêì</div>
            <div>Leghorn</div>
          </div>
          <div
            class="breed-option"
            data-breed="plymouth"
            onclick="selectBreed(this)"
          >
            <div class="breed-icon">üê§</div>
            <div>Plymouth Rock</div>
          </div>
          <div
            class="breed-option"
            data-breed="orpington"
            onclick="selectBreed(this)"
          >
            <div class="breed-icon">ü™∫</div>
            <div>Orpington</div>
          </div>
        </div>

        <div style="text-align: center; margin-top: 20px">
          <button class="btn" onclick="createChicken()">
            ü•ö Hatch My Chicken!
          </button>
          <button class="btn blue" onclick="showScreen('welcome-screen')">
            ‚¨ÖÔ∏è Back
          </button>
        </div>
      </div>

      <!-- Main Game Screen -->
      <div id="game-screen" class="screen">
        <div style="text-align: center">
          <div class="money-display">üí∞ $<span id="money-amount">5</span></div>
        </div>

        <div class="nav-bar">
          <div
            class="nav-item active"
            onclick="showTab('chicken')"
            id="nav-chicken"
          >
            <div class="icon">üêî</div>
            <div>Chicken</div>
          </div>
          <div class="nav-item" onclick="showTab('shop')" id="nav-shop">
            <div class="icon">üõí</div>
            <div>Shop</div>
          </div>
          <div class="nav-item" onclick="showTab('friends')" id="nav-friends">
            <div class="icon">üë•</div>
            <div>Friends</div>
          </div>
          <div class="nav-item" onclick="showTab('share')" id="nav-share">
            <div class="icon">üì±</div>
            <div>Share</div>
          </div>
        </div>

        <!-- Chicken Tab -->
        <div id="chicken-tab" class="tab-content">
          <div class="chicken-display">
            <div id="chicken-ascii" class="ascii-art"></div>
            <h2 id="display-name">Clucky</h2>
            <p id="display-breed" style="color: #888">ISA Brown</p>
            <p id="display-owner" style="color: #666; font-size: 0.9em">
              Owner: You
            </p>
          </div>

          <div class="info-box">
            <strong>üåü Life Stage:</strong> <span id="life-stage">Egg</span>
            <br /><strong>üìÖ Age:</strong> <span id="chicken-age">0 days</span>
            <div class="lifecycle-bar">
              <div
                class="lifecycle-progress"
                id="lifecycle-progress"
                style="width: 5%"
              ></div>
            </div>
          </div>

          <h2>‚ù§Ô∏è How's My Chicken?</h2>
          <div class="status-bar" id="status-bar">
            <span class="status-item">üòä Happy</span>
          </div>

          <h2>üéÆ Actions</h2>
          <div class="action-buttons">
            <button class="btn small green" onclick="doAction('feed')">
              üåæ Feed
            </button>
            <button class="btn small blue" onclick="doAction('water')">
              üíß Water
            </button>
            <button class="btn small orange" onclick="doAction('dustbath')">
              üõÅ Dust Bath
            </button>
            <button class="btn small" onclick="doAction('play')">
              üéæ Play
            </button>
            <button class="btn small green" onclick="doAction('sleep')">
              üò¥ Sleep
            </button>
            <button class="btn small blue" onclick="doAction('flap')">
              ü™Ω Let Flap
            </button>
          </div>

          <h2>üèÜ Milestones</h2>
          <div class="milestone-list" id="milestone-list"></div>
        </div>

        <!-- Shop Tab -->
        <div id="shop-tab" class="tab-content hidden">
          <h2>üõí Chicken Shop</h2>
          <p style="text-align: center; color: #666; margin: 10px 0">
            Buy cute stuff for your chicken! üéÅ
          </p>

          <div id="shop-items"></div>

          <h2>üéí My Items</h2>
          <div id="inventory" class="inventory-grid">
            <p style="text-align: center; color: #888; width: 100%">
              No items yet!
            </p>
          </div>
        </div>

        <!-- Friends Tab -->
        <div id="friends-tab" class="tab-content hidden">
          <h2>üë• My Chicken Friends</h2>

          <div class="scan-area">
            <p>üì∏ Paste your friend's chicken code below:</p>
            <textarea
              id="friend-code-input"
              placeholder="Paste chicken code here..."
            ></textarea>
            <button class="btn green" onclick="addFriend()">
              ‚ûï Add Friend
            </button>
          </div>

          <div id="friends-list">
            <p style="text-align: center; color: #888; margin: 20px 0">
              No friends yet! üê£<br />
              Scan a friend's code to add them!
            </p>
          </div>
        </div>

        <!-- Share Tab -->
        <div id="share-tab" class="tab-content hidden">
          <h2>üì± Share Your Chicken</h2>
          <p style="text-align: center; color: #666; margin: 10px 0">
            Show this code to your friends so they can add your chicken! üêî
          </p>

          <div class="qr-container">
            <div id="qrcode"></div>
            <p style="margin-top: 10px; font-size: 0.8em; color: #888">
              Scan with camera or copy the code below
            </p>
          </div>

          <div style="text-align: center">
            <button class="btn small blue" onclick="copyChickenCode()">
              üìã Copy Code
            </button>
          </div>

          <div class="info-box" style="margin-top: 15px">
            <strong>Your Chicken Code:</strong>
            <textarea
              id="chicken-code"
              readonly
              style="min-height: 60px; font-size: 0.8em"
            ></textarea>
          </div>
        </div>
      </div>
    </div>

    <!-- Message Popup -->
    <div id="overlay" class="overlay hidden" onclick="hidePopup()"></div>
    <div id="popup" class="message-popup hidden">
      <div id="popup-content"></div>
      <button class="btn small" onclick="hidePopup()">OK! üëç</button>
    </div>

    <script>
      // ============= GAME DATA =============
      const BREEDS = {
        "isa-brown": { name: "ISA Brown", color: "#8B4513", eggColor: "brown" },
        silkie: { name: "Silkie", color: "#F5F5DC", eggColor: "cream" },
        leghorn: { name: "Leghorn", color: "#FFFFFF", eggColor: "white" },
        plymouth: {
          name: "Plymouth Rock",
          color: "#808080",
          eggColor: "brown",
        },
        orpington: { name: "Orpington", color: "#FFD700", eggColor: "brown" },
      };

      const MILESTONES = [
        { day: 0, name: "ü•ö Egg", stage: "egg" },
        { day: 1, name: "üê£ Hatching!", stage: "hatching" },
        { day: 2, name: "üê• Fluffy Chick", stage: "chick" },
        { day: 7, name: "üê§ One Week Old", stage: "chick-week" },
        { day: 30, name: "üêî One Month Old", stage: "pullet" },
        { day: 60, name: "üêî Two Months Old", stage: "pullet2" },
        { day: 90, name: "üêî Three Months Old", stage: "teenager" },
        { day: 150, name: "ü•ö First Egg!", stage: "laying" },
        { day: 180, name: "üêì Six Months Old", stage: "adult" },
        { day: 365, name: "üéÇ One Year Old!", stage: "mature" },
      ];

      const STATUSES = {
        happy: { icon: "üòä", text: "Happy", priority: 0 },
        hungry: { icon: "üçΩÔ∏è", text: "Hungry", priority: 2 },
        thirsty: { icon: "üíß", text: "Needs Water", priority: 2 },
        dusty: { icon: "üõÅ", text: "Needs Dust Bath", priority: 1 },
        sleepy: { icon: "üò¥", text: "Sleepy", priority: 1 },
        wantFlap: { icon: "ü™Ω", text: "Wants to Flap", priority: 1 },
        sick: { icon: "ü§í", text: "Sick", priority: 3 },
        bored: { icon: "üòê", text: "Bored", priority: 1 },
      };

      // Shop items
      const SHOP_ITEMS = {
        "fake-eggs": {
          id: "fake-eggs",
          name: "Fake Chicken Eggs",
          icon: "ü•ö",
          price: 1,
          description: "Cute decorative eggs! Makes chicken +10 happier.",
          effect: { happiness: 10 },
        },
        "cup-water-set": {
          id: "cup-water-set",
          name: "Cup & Water Set",
          icon: "ü•§",
          price: 1,
          description: "Fancy drinking set! Water lasts longer.",
          effect: { thirstDecayReduction: 0.3 },
        },
        "fancy-seeds": {
          id: "fancy-seeds",
          name: "Fancy Seeds",
          icon: "üåª",
          price: 1,
          description: "Delicious premium seeds! Food lasts longer.",
          effect: { hungerDecayReduction: 0.3 },
        },
        "chicken-toy": {
          id: "chicken-toy",
          name: "Chicken Toy",
          icon: "üéÄ",
          price: 1,
          description: "A fun toy to play with! Less boredom.",
          effect: { happinessDecayReduction: 0.3 },
        },
      };

      // ASCII Art for different stages
      const ASCII_ART = {
        egg: `
      ___
     /   \\
    |     |
    |     |
     \\___/
      ü•ö
`,
        hatching: `
      ___
     / ^ \\
    | o o |
    |  >  |
     \\___/
    crack!
`,
        chick: `
      __
     (o>
    \\(_\\
      ^^
     peep!
`,
        "chick-week": `
       __
      (o>
    \\\\(_\\
     \` ^^
    chirp!
`,
        pullet: `
      \\\\
    _  \\\\
   / \\  ||
  ( @ > ||
   \\__///
    ||//
    ^^
`,
        pullet2: `
       \\\\
     _  \\\\
    / \\  ||
   ( @)> ||
    \\__///
     ||//
     ^^
`,
        teenager: `
        \\\\
      _  \\\\
     /,\\  ||
    ( @)> ||
     \\__///
      ||//
      ^^
`,
        laying: `
        \\\\
      _  \\\\
     /,\\  ||
    ( @)> ||
     \\__///
      ||//
      ^^  ü•ö
`,
        adult: `
         \\\\
       _  \\\\
      /,\\  ||
     ( @)> ||
      \\__///
       ||//
       ^^
      proud!
`,
        mature: `
          \\\\
        _  \\\\
       /,\\  ||
      ( @)> ||  ‚≠ê
       \\__///
        ||//
        ^^
`,
        sick: `
      \\\\
    _  \\\\
   / \\  ||
  ( x > ||
   \\__///
    ||//  üíä
    ^^
`,
      };

      // ============= GAME STATE =============
      let gameState = {
        chicken: null,
        friends: [],
        lastUpdate: null,
        money: 5,
        inventory: [],
      };

      let selectedBreed = null;

      // ============= INITIALIZATION =============
      function init() {
        loadGame();
        if (gameState.chicken) {
          updateGame();
          updateMoneyDisplay();
          showScreen("game-screen");
        }
        // Update game every minute
        setInterval(updateGame, 60000);
      }

      // ============= SCREEN MANAGEMENT =============
      function showScreen(screenId) {
        document
          .querySelectorAll(".screen")
          .forEach((s) => s.classList.remove("active"));
        document.getElementById(screenId).classList.add("active");
      }

      function showTab(tabName) {
        document
          .querySelectorAll(".tab-content")
          .forEach((t) => t.classList.add("hidden"));
        document
          .querySelectorAll(".nav-item")
          .forEach((n) => n.classList.remove("active"));
        document.getElementById(tabName + "-tab").classList.remove("hidden");
        document.getElementById("nav-" + tabName).classList.add("active");

        if (tabName === "share") {
          generateQRCode();
        }
        if (tabName === "shop") {
          renderShop();
        }
      }

      // ============= CHICKEN CREATION =============
      function selectBreed(element) {
        document
          .querySelectorAll(".breed-option")
          .forEach((b) => b.classList.remove("selected"));
        element.classList.add("selected");
        selectedBreed = element.dataset.breed;
      }

      function createChicken() {
        const ownerName = document.getElementById("owner-name").value.trim();
        const chickenName = document
          .getElementById("chicken-name")
          .value.trim();

        if (!ownerName) {
          showPopup("üôà Please enter your name!");
          return;
        }
        if (!chickenName) {
          showPopup("üêî Please name your chicken!");
          return;
        }
        if (!selectedBreed) {
          showPopup("üê£ Please select a breed!");
          return;
        }

        gameState.chicken = {
          id: generateId(),
          name: chickenName,
          owner: ownerName,
          breed: selectedBreed,
          birthDate: Date.now(),
          needs: {
            hunger: 100,
            thirst: 100,
            cleanliness: 100,
            sleep: 100,
            happiness: 100,
            exercise: 100,
          },
          totalEggs: 0,
          isSick: false,
        };

        gameState.lastUpdate = Date.now();
        saveGame();
        updateGame();
        showScreen("game-screen");
        showPopup(
          `üéâ Welcome ${chickenName}! üê£<br>Your egg is about to hatch!`
        );
      }

      // ============= GAME LOGIC =============
      function updateGame() {
        if (!gameState.chicken) return;

        const now = Date.now();
        const timePassed = now - gameState.lastUpdate;
        const minutesPassed = timePassed / 60000;

        // Update needs (decrease over time) - with item effects
        const decay = minutesPassed * 0.5; // Needs decrease by 0.5 per minute

        // Check for item effects that reduce decay
        let hungerDecay = decay;
        let thirstDecay = decay * 1.2;
        let happinessDecay = decay * 0.2;

        if (gameState.inventory.includes("fancy-seeds")) {
          hungerDecay *= 0.7; // 30% slower hunger decay
        }
        if (gameState.inventory.includes("cup-water-set")) {
          thirstDecay *= 0.7; // 30% slower thirst decay
        }
        if (gameState.inventory.includes("chicken-toy")) {
          happinessDecay *= 0.7; // 30% slower happiness decay
        }

        gameState.chicken.needs.hunger = Math.max(
          0,
          gameState.chicken.needs.hunger - hungerDecay
        );
        gameState.chicken.needs.thirst = Math.max(
          0,
          gameState.chicken.needs.thirst - thirstDecay
        );
        gameState.chicken.needs.cleanliness = Math.max(
          0,
          gameState.chicken.needs.cleanliness - decay * 0.3
        );
        gameState.chicken.needs.sleep = Math.max(
          0,
          gameState.chicken.needs.sleep - decay * 0.4
        );
        gameState.chicken.needs.happiness = Math.max(
          0,
          gameState.chicken.needs.happiness - happinessDecay
        );
        gameState.chicken.needs.exercise = Math.max(
          0,
          gameState.chicken.needs.exercise - decay * 0.3
        );

        // Check if chicken gets sick (if needs are too low)
        const avgNeeds =
          Object.values(gameState.chicken.needs).reduce((a, b) => a + b, 0) / 6;
        if (avgNeeds < 30 && Math.random() < 0.1) {
          gameState.chicken.isSick = true;
        }

        gameState.lastUpdate = now;
        saveGame();
        renderChicken();
      }

      function doAction(action) {
        if (!gameState.chicken) return;

        let message = "";
        switch (action) {
          case "feed":
            gameState.chicken.needs.hunger = Math.min(
              100,
              gameState.chicken.needs.hunger + 40
            );
            message = "üåæ Yummy! *peck peck peck*";
            break;
          case "water":
            gameState.chicken.needs.thirst = Math.min(
              100,
              gameState.chicken.needs.thirst + 50
            );
            message = "üíß *gulp gulp* Refreshing!";
            break;
          case "dustbath":
            gameState.chicken.needs.cleanliness = Math.min(
              100,
              gameState.chicken.needs.cleanliness + 60
            );
            gameState.chicken.needs.happiness = Math.min(
              100,
              gameState.chicken.needs.happiness + 10
            );
            message = "üõÅ *fluff fluff* So fluffy!";
            break;
          case "play":
            gameState.chicken.needs.happiness = Math.min(
              100,
              gameState.chicken.needs.happiness + 30
            );
            gameState.chicken.needs.exercise = Math.min(
              100,
              gameState.chicken.needs.exercise + 20
            );
            message = "üéæ *bawk bawk* So fun!";
            break;
          case "sleep":
            gameState.chicken.needs.sleep = Math.min(
              100,
              gameState.chicken.needs.sleep + 50
            );
            if (gameState.chicken.isSick && Math.random() < 0.3) {
              gameState.chicken.isSick = false;
              message = "üò¥ Zzz... Feeling better!";
            } else {
              message = "üò¥ Zzz... Good night!";
            }
            break;
          case "flap":
            gameState.chicken.needs.exercise = Math.min(
              100,
              gameState.chicken.needs.exercise + 40
            );
            gameState.chicken.needs.happiness = Math.min(
              100,
              gameState.chicken.needs.happiness + 15
            );
            message = "ü™Ω *flap flap flap* Wheee!";
            break;
        }

        // Earn $1 for taking care of chicken!
        gameState.money += 1;
        message += '<br><span class="coin-earn">+$1 üí∞</span>';
        updateMoneyDisplay();

        saveGame();
        renderChicken();
        showPopup(message);
      }

      // ============= RENDERING =============
      function renderChicken() {
        if (!gameState.chicken) return;

        const chicken = gameState.chicken;
        const ageInDays = Math.floor(
          (Date.now() - chicken.birthDate) / (1000 * 60 * 60 * 24)
        );

        // Get current stage
        let currentStage = MILESTONES[0];
        for (const milestone of MILESTONES) {
          if (ageInDays >= milestone.day) {
            currentStage = milestone;
          }
        }

        // Update display
        document.getElementById("display-name").textContent = chicken.name;
        document.getElementById("display-breed").textContent =
          BREEDS[chicken.breed].name;
        document.getElementById(
          "display-owner"
        ).textContent = `Owner: ${chicken.owner}`;
        document.getElementById("life-stage").textContent = currentStage.name;
        document.getElementById("chicken-age").textContent =
          formatAge(ageInDays);

        // Progress bar
        const nextMilestone =
          MILESTONES.find((m) => m.day > ageInDays) ||
          MILESTONES[MILESTONES.length - 1];
        const prevMilestone =
          [...MILESTONES].reverse().find((m) => m.day <= ageInDays) ||
          MILESTONES[0];
        const progress =
          ((ageInDays - prevMilestone.day) /
            (nextMilestone.day - prevMilestone.day)) *
          100;
        const totalProgress =
          ((MILESTONES.findIndex((m) => m.day === currentStage.day) + 1) /
            MILESTONES.length) *
          100;
        document.getElementById("lifecycle-progress").style.width =
          Math.min(100, totalProgress) + "%";

        // ASCII art
        const artStage = chicken.isSick ? "sick" : currentStage.stage;
        document.getElementById("chicken-ascii").textContent =
          ASCII_ART[artStage] || ASCII_ART["chick"];

        // Status bar
        renderStatus();

        // Milestones
        renderMilestones(ageInDays);
      }

      function renderStatus() {
        const chicken = gameState.chicken;
        const statusBar = document.getElementById("status-bar");
        const activeStatuses = [];

        if (chicken.isSick) {
          activeStatuses.push({ ...STATUSES.sick, key: "sick" });
        }
        if (chicken.needs.hunger < 40) {
          activeStatuses.push({ ...STATUSES.hungry, key: "hungry" });
        }
        if (chicken.needs.thirst < 40) {
          activeStatuses.push({ ...STATUSES.thirsty, key: "thirsty" });
        }
        if (chicken.needs.cleanliness < 40) {
          activeStatuses.push({ ...STATUSES.dusty, key: "dusty" });
        }
        if (chicken.needs.sleep < 40) {
          activeStatuses.push({ ...STATUSES.sleepy, key: "sleepy" });
        }
        if (chicken.needs.exercise < 40) {
          activeStatuses.push({ ...STATUSES.wantFlap, key: "wantFlap" });
        }
        if (chicken.needs.happiness < 40) {
          activeStatuses.push({ ...STATUSES.bored, key: "bored" });
        }

        if (activeStatuses.length === 0) {
          activeStatuses.push({ ...STATUSES.happy, key: "happy" });
        }

        statusBar.innerHTML = activeStatuses
          .map((s) => {
            let className = "status-item";
            if (s.priority >= 3) className += " critical";
            else if (s.priority >= 2) className += " warning";
            return `<span class="${className}">${s.icon} ${s.text}</span>`;
          })
          .join("");
      }

      function renderMilestones(currentAge) {
        const list = document.getElementById("milestone-list");
        list.innerHTML = MILESTONES.map((m) => {
          let className = "milestone";
          let icon = "‚¨ú";
          if (currentAge >= m.day) {
            className += " achieved";
            icon = "‚úÖ";
          }
          const currentMilestone = MILESTONES.filter(
            (x) => currentAge >= x.day
          ).pop();
          if (currentMilestone && m.day === currentMilestone.day) {
            className += " current";
          }
          return `<div class="${className}">${icon} ${m.name} (Day ${m.day})</div>`;
        }).join("");
      }

      // ============= QR CODE & SHARING =============
      function generateQRCode() {
        const code = encodeChickenData();
        document.getElementById("chicken-code").value = code;

        // Generate simple visual QR-like pattern
        const qrDiv = document.getElementById("qrcode");
        qrDiv.innerHTML = generateVisualCode(code);
      }

      function encodeChickenData() {
        const c = gameState.chicken;
        const ageInDays = Math.floor(
          (Date.now() - c.birthDate) / (1000 * 60 * 60 * 24)
        );

        // Get current stage
        let stage = "egg";
        for (const milestone of MILESTONES) {
          if (ageInDays >= milestone.day) {
            stage = milestone.stage;
          }
        }

        const data = {
          n: c.name,
          o: c.owner,
          b: c.breed,
          a: ageInDays,
          s: stage,
          h: Math.round(
            (c.needs.hunger +
              c.needs.thirst +
              c.needs.cleanliness +
              c.needs.sleep +
              c.needs.happiness +
              c.needs.exercise) /
              6
          ),
          i: c.id,
        };

        // Use simple prefix for QR compatibility
        // Make the data shorter by using minimal JSON and URL-safe base64
        const jsonStr = JSON.stringify(data);
        const base64 = btoa(jsonStr)
          .replace(/\+/g, "-")
          .replace(/\//g, "_")
          .replace(/=/g, "");
        return "CHKN" + base64;
      }

      function generateVisualCode(code) {
        // Use qrcode-generator library (loaded from CDN)
        // Type 0 = auto-detect version based on data length
        const qr = qrcode(0, "L");
        qr.addData(code);
        qr.make();

        const size = qr.getModuleCount();
        const pixelSize = Math.max(5, Math.floor(180 / size));

        // Color theme
        const codeSum = code
          .split("")
          .reduce((sum, c) => sum + c.charCodeAt(0), 0);
        const colors = [
          { dark: "#000000", light: "#FFF0F5", border: "#FF69B4" },
          { dark: "#000000", light: "#F8F0FF", border: "#9932CC" },
          { dark: "#000000", light: "#FFF5F5", border: "#FF6347" },
          { dark: "#000000", light: "#F0FFF0", border: "#32CD32" },
          { dark: "#000000", light: "#F0F8FF", border: "#4169E1" },
        ];
        const theme = colors[codeSum % colors.length];

        let html = `<div style="display: inline-block; padding: 15px; background: ${theme.light}; border-radius: 15px; border: 3px solid ${theme.border};">`;
        html += `<div style="text-align: center; margin-bottom: 8px;"><span style="font-size: 1.8em;">üêî</span></div>`;
        html += `<div style="display: inline-block; padding: 10px; background: white; border-radius: 8px;">`;
        html += `<div style="display: grid; grid-template-columns: repeat(${size}, ${pixelSize}px); gap: 0;">`;

        for (let row = 0; row < size; row++) {
          for (let col = 0; col < size; col++) {
            const color = qr.isDark(row, col) ? theme.dark : "white";
            html += `<div style="width:${pixelSize}px;height:${pixelSize}px;background:${color};"></div>`;
          }
        }

        html += "</div></div>";
        const sparkles = ["‚ú®", "üíï", "‚≠ê", "üå∏", "üí´"];
        html += `<div style="text-align:center;margin-top:8px;font-size:0.95em;color:${
          theme.border
        };font-weight:500;">${sparkles[codeSum % 5]} Scan Me! ${
          sparkles[(codeSum + 2) % 5]
        }</div>`;
        html += "</div>";

        return html;
      }

      function copyChickenCode() {
        const code = document.getElementById("chicken-code").value;
        navigator.clipboard
          .writeText(code)
          .then(() => {
            showPopup("üìã Code copied! Share it with friends!");
          })
          .catch(() => {
            showPopup("üìã Select the code and copy manually!");
          });
      }

      // ============= FRIENDS =============
      function addFriend() {
        const input = document.getElementById("friend-code-input").value.trim();

        if (!input) {
          showPopup("üôà Please paste a chicken code!");
          return;
        }

        try {
          // Support old format (üêî...üêî), middle format (CHKN:...), and new format (CHKN...)
          let base64Data;
          const emojiMatch = input.match(/üêî(.+)üêî/);
          const colonMatch = input.match(/CHKN:(.+)/);
          const newMatch = input.match(/^CHKN([A-Za-z0-9_-]+)$/);

          if (emojiMatch) {
            base64Data = emojiMatch[1];
          } else if (colonMatch) {
            base64Data = colonMatch[1];
          } else if (newMatch) {
            // Convert URL-safe base64 back to standard
            base64Data = newMatch[1].replace(/-/g, "+").replace(/_/g, "/");
            // Add padding if needed
            while (base64Data.length % 4) base64Data += "=";
          } else {
            throw new Error("Invalid format");
          }

          const data = JSON.parse(atob(base64Data));

          // Check if already a friend
          if (gameState.friends.some((f) => f.i === data.i)) {
            showPopup("üêî This chicken is already your friend!");
            return;
          }

          // Check if it's your own chicken
          if (data.i === gameState.chicken.id) {
            showPopup("ü§≠ That's your own chicken, silly!");
            return;
          }

          gameState.friends.push(data);
          saveGame();
          renderFriends();
          document.getElementById("friend-code-input").value = "";
          showPopup(`üéâ ${data.n} is now your friend!`);
        } catch (e) {
          showPopup("üòï Invalid chicken code. Try again!");
        }
      }

      function renderFriends() {
        const list = document.getElementById("friends-list");

        if (gameState.friends.length === 0) {
          list.innerHTML = `
                    <p style="text-align: center; color: #888; margin: 20px 0;">
                        No friends yet! üê£<br>
                        Scan a friend's code to add them!
                    </p>
                `;
          return;
        }

        list.innerHTML = gameState.friends
          .map((f) => {
            const breedInfo = BREEDS[f.b] || { name: "Unknown" };
            const currentMilestone =
              MILESTONES.filter((m) => f.a >= m.day).pop() || MILESTONES[0];
            const healthEmoji = f.h >= 70 ? "üíö" : f.h >= 40 ? "üíõ" : "‚ù§Ô∏è";

            return `
                    <div class="friend-card">
                        <div class="name">üêî ${f.n}</div>
                        <div>Owner: ${f.o}</div>
                        <div>Breed: ${breedInfo.name}</div>
                        <div>Stage: ${currentMilestone.name}</div>
                        <div>Health: ${healthEmoji} ${f.h}%</div>
                    </div>
                `;
          })
          .join("");
      }

      // ============= UTILITIES =============
      function generateId() {
        return "ck_" + Math.random().toString(36).substr(2, 9);
      }

      function formatAge(days) {
        if (days === 0) return "Just born!";
        if (days === 1) return "1 day old";
        if (days < 7) return `${days} days old`;
        if (days < 30)
          return `${Math.floor(days / 7)} week${days >= 14 ? "s" : ""} old`;
        if (days < 365)
          return `${Math.floor(days / 30)} month${days >= 60 ? "s" : ""} old`;
        return `${Math.floor(days / 365)} year${days >= 730 ? "s" : ""} old`;
      }

      function showPopup(message) {
        document.getElementById("popup-content").innerHTML = message;
        document.getElementById("popup").classList.remove("hidden");
        document.getElementById("overlay").classList.remove("hidden");
      }

      function hidePopup() {
        document.getElementById("popup").classList.add("hidden");
        document.getElementById("overlay").classList.add("hidden");
      }

      function updateMoneyDisplay() {
        document.getElementById("money-amount").textContent = gameState.money;
      }

      // ============= SHOP SYSTEM =============
      function renderShop() {
        const shopDiv = document.getElementById("shop-items");

        shopDiv.innerHTML = Object.values(SHOP_ITEMS)
          .map((item) => {
            const owned = gameState.inventory.includes(item.id);
            return `
                    <div class="shop-item ${owned ? "owned" : ""}">
                        <div class="item-icon">${item.icon}</div>
                        <div class="item-info">
                            <div class="item-name">${item.name}</div>
                            <div class="item-desc">${item.description}</div>
                        </div>
                        ${
                          owned
                            ? '<span class="owned-badge">‚úì Owned</span>'
                            : `<button class="btn small" onclick="buyItem('${item.id}')">$${item.price}</button>`
                        }
                    </div>
                `;
          })
          .join("");

        renderInventory();
      }

      function renderInventory() {
        const invDiv = document.getElementById("inventory");

        if (gameState.inventory.length === 0) {
          invDiv.innerHTML =
            '<p style="text-align: center; color: #888; width: 100%;">No items yet! üõí</p>';
          return;
        }

        invDiv.innerHTML = gameState.inventory
          .map((itemId) => {
            const item = SHOP_ITEMS[itemId];
            return `
                    <div class="inventory-item">
                        <div class="item-emoji">${item.icon}</div>
                        <div style="font-size: 0.75em;">${
                          item.name.split(" ")[0]
                        }</div>
                    </div>
                `;
          })
          .join("");
      }

      function buyItem(itemId) {
        const item = SHOP_ITEMS[itemId];

        if (gameState.inventory.includes(itemId)) {
          showPopup("üõí You already have this item!");
          return;
        }

        if (gameState.money < item.price) {
          showPopup(
            "üí∏ Not enough money!<br>Take care of your chicken to earn more!"
          );
          return;
        }

        gameState.money -= item.price;
        gameState.inventory.push(itemId);

        // Apply immediate happiness boost for fake eggs
        if (itemId === "fake-eggs" && gameState.chicken) {
          gameState.chicken.needs.happiness = Math.min(
            100,
            gameState.chicken.needs.happiness + 10
          );
        }

        updateMoneyDisplay();
        saveGame();
        renderShop();
        showPopup(
          `üéâ You bought ${item.name}!<br>${item.icon} ${item.description}`
        );
      }

      // ============= SAVE/LOAD =============
      function saveGame() {
        localStorage.setItem("chickenGame", JSON.stringify(gameState));
      }

      function loadGame() {
        const saved = localStorage.getItem("chickenGame");
        if (saved) {
          const loaded = JSON.parse(saved);
          gameState = {
            ...gameState,
            ...loaded,
            // Ensure money and inventory exist for old saves
            money: loaded.money !== undefined ? loaded.money : 5,
            inventory: loaded.inventory || [],
          };
        }
      }

      function loadExistingChicken() {
        loadGame();
        if (gameState.chicken) {
          updateGame();
          updateMoneyDisplay();
          showScreen("game-screen");
          renderFriends();
        } else {
          showPopup("üê£ No saved chicken found!<br>Create a new one!");
        }
      }

      // Start the game!
      init();
    </script>
  </body>
</html>
